{% extends 'base.html' %}

{% block title %}ANNEXURE-I{% endblock %}

{% block styles %}
<style>
    .photo-container {
        margin-bottom: 20px;
        position: relative;
        border: 1px solid #ccc;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        overflow: hidden;
    }
    .photo-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .photo-controls {
        margin-bottom: 15px;
    }
    .photo-preview {
        display: none;
    }
    .delete-photo {
        position: absolute;
        top: 5px;
        right: 5px;
        cursor: pointer;
        background-color: rgba(255, 0, 0, 0.7);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        text-align: center;
        line-height: 24px;
    }
    .camera-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .camera-view {
        max-width: 90%;
        max-height: 70vh;
        margin-bottom: 20px;
    }
    .camera-controls {
        display: flex;
        gap: 10px;
    }
    .column-header {
        background-color: #343a40;
        color: white;
        padding: 10px;
        margin-bottom: 15px;
        text-align: center;
        font-weight: bold;
    }
    .annexure-title {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
    }
    .company-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .company-logo {
        height: 60px;
        margin-right: 15px;
    }
    .company-name {
        font-size: 22px;
        font-weight: bold;
        color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    {% include 'includes/navigation.html' %}
    
    <!-- Company Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='images/logo.png') }}?v={{ range(1000, 9999) | random }}" alt="Vitrag Associates Logo" class="company-logo">
                            <div>
                                <div class="company-name">Vitrag Associates LLP</div>
                                <div>Construction Material Testing Laboratory</div>
                            </div>
                        </div>
                        <div>
                            <img src="{{ url_for('static', filename='images/tc-11552.png') }}" alt="TC-11552" height="60">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h1 class="display-5 fw-bold" style="color: #FFD700;">Vitrag Associates LLP</h1>
                        <p class="lead" style="color: #FFA500;">Construction Material Testing Laboratory</p>
                        <h2 class="annexure-title mt-4" style="color: #0d6efd;">ANNEXURE-I</h2>
                    </div>
                    
                    <!-- Test details removed as requested -->
                    
                    <!-- Column Headers (only once at the top) -->
                    <div class="row mb-3 mt-4">
                        <div class="col-md-4">
                            <div class="column-header">Pictorial view of Front side<br>failure of Cube specimen</div>
                        </div>
                        <div class="col-md-4">
                            <div class="column-header">Digital reading of Load &<br>Compressive Strength</div>
                        </div>
                        <div class="col-md-4">
                            <div class="column-header">Pictorial view of Back side<br>failure of Cube specimen</div>
                        </div>
                    </div>
                    
                    <!-- Cube Rows -->
                    {% for cube_num in range(1, max_cubes + 1) %}
                    <div class="row mb-4 pb-3 border-bottom">
                        <div class="col-12 mb-2">
                            <h5>Cube/Core Specimen #{{ cube_num }}</h5>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="photo-container" id="front_failure_{{ cube_num }}_container">
                                {% if photos[cube_num]['front_failure'] %}
                                    <img src="data:image/jpeg;base64,{{ photos[cube_num]['front_failure'].photo_data }}" alt="Front Failure">
                                    <span class="delete-photo" data-photo-id="{{ photos[cube_num]['front_failure'].id }}" data-type="front_failure" data-cube="{{ cube_num }}">&times;</span>
                                {% else %}
                                    <span>No photo</span>
                                {% endif %}
                            </div>
                            <div class="photo-controls d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm capture-btn" data-type="front_failure" data-cube="{{ cube_num }}">
                                    <i class="fas fa-camera"></i> Capture
                                </button>
                                <div class="upload-container">
                                    <input type="file" id="front_failure_{{ cube_num }}_file" class="photo-file d-none" 
                                           data-type="front_failure" data-cube="{{ cube_num }}" accept="image/*">
                                    <button class="btn btn-secondary btn-sm upload-btn" data-target="front_failure_{{ cube_num }}_file">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="photo-container" id="digital_reading_{{ cube_num }}_container">
                                {% if photos[cube_num]['digital_reading'] %}
                                    <img src="data:image/jpeg;base64,{{ photos[cube_num]['digital_reading'].photo_data }}" alt="Digital Reading">
                                    <span class="delete-photo" data-photo-id="{{ photos[cube_num]['digital_reading'].id }}" data-type="digital_reading" data-cube="{{ cube_num }}">&times;</span>
                                {% else %}
                                    <span>No photo</span>
                                {% endif %}
                            </div>
                            <div class="photo-controls d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm capture-btn" data-type="digital_reading" data-cube="{{ cube_num }}">
                                    <i class="fas fa-camera"></i> Capture
                                </button>
                                <div class="upload-container">
                                    <input type="file" id="digital_reading_{{ cube_num }}_file" class="photo-file d-none" 
                                           data-type="digital_reading" data-cube="{{ cube_num }}" accept="image/*">
                                    <button class="btn btn-secondary btn-sm upload-btn" data-target="digital_reading_{{ cube_num }}_file">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="photo-container" id="back_failure_{{ cube_num }}_container">
                                {% if photos[cube_num]['back_failure'] %}
                                    <img src="data:image/jpeg;base64,{{ photos[cube_num]['back_failure'].photo_data }}" alt="Back Failure">
                                    <span class="delete-photo" data-photo-id="{{ photos[cube_num]['back_failure'].id }}" data-type="back_failure" data-cube="{{ cube_num }}">&times;</span>
                                {% else %}
                                    <span>No photo</span>
                                {% endif %}
                            </div>
                            <div class="photo-controls d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm capture-btn" data-type="back_failure" data-cube="{{ cube_num }}">
                                    <i class="fas fa-camera"></i> Capture
                                </button>
                                <div class="upload-container">
                                    <input type="file" id="back_failure_{{ cube_num }}_file" class="photo-file d-none" 
                                           data-type="back_failure" data-cube="{{ cube_num }}" accept="image/*">
                                    <button class="btn btn-secondary btn-sm upload-btn" data-target="back_failure_{{ cube_num }}_file">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('view_sample', id=test.test_request.id) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Test Details
                        </a>
                        
                        <div>
                            <a href="/test/{{ test.id }}/photos/pdf" class="btn btn-success me-2" target="_blank">
                                <i class="fas fa-file-pdf"></i> View as PDF
                            </a>
                            
                            <button class="btn btn-info me-2" onclick="window.print()">
                                <i class="fas fa-print"></i> Print
                            </button>
                            
                            <a href="mailto:{% if customer.email %}{{ customer.email }}{% endif %}?subject=Test Photos - {{ test.job_number }}&body=Please find the test photos for {{ test.job_number }} attached.%0D%0A%0D%0ARegards,%0D%0AVitrag Associates LLP" class="btn btn-warning me-2" target="_blank">
                                <i class="fas fa-envelope"></i> Email
                            </a>
                            
                            <a href="https://wa.me/{% if customer.phone %}91{{ customer.phone }}{% endif %}?text=Please find the test photos for {{ test.job_number }} here: {{ url_for('test_photos_pdf', test_id=test.id, _external=True) }}" class="btn btn-success" target="_blank">
                                <i class="fab fa-whatsapp"></i> WhatsApp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>

<!-- Camera Capture Modal -->
<div class="camera-container" id="cameraModal">
    <video id="camera" class="camera-view" autoplay></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div class="camera-controls">
        <button id="flipCameraBtn" class="btn btn-info me-2">
            <i class="fas fa-sync-alt"></i> Switch to Front
        </button>
        <button id="captureBtn" class="btn btn-primary">
            <i class="fas fa-camera"></i> Take Photo
        </button>
        <button id="cancelCaptureBtn" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables to track current photo being taken
    let currentPhotoType = null;
    let currentCubeNum = null;
    let videoStream = null;
    let currentFacingMode = 'environment'; // Start with back camera for concrete testing
    
    // Camera handling
    const cameraModal = document.getElementById('cameraModal');
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCaptureBtn = document.getElementById('cancelCaptureBtn');
    const flipCameraBtn = document.getElementById('flipCameraBtn');
    
    // FORCE BACK CAMERA - Simple and direct approach
    document.querySelectorAll('.capture-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            currentPhotoType = this.getAttribute('data-type');
            currentCubeNum = this.getAttribute('data-cube');
            
            // FORCE back camera immediately - no complex detection
            navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: { exact: 'environment' },  // FORCE back camera
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 }
                }
            })
            .then(stream => {
                console.log('BACK CAMERA ACTIVATED');
                videoStream = stream;
                video.srcObject = stream;
                video.play();
                cameraModal.style.display = 'flex';
                
                // Update flip button to show current camera
                flipCameraBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Switch to Front';
                currentFacingMode = 'environment';
            })
            .catch(error => {
                console.error('Back camera failed, trying any camera:', error);
                // Only if back camera completely fails
                navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',  // Try without exact
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                })
                .then(stream => {
                    videoStream = stream;
                    video.srcObject = stream;
                    video.play();
                    cameraModal.style.display = 'flex';
                    currentFacingMode = 'environment';
                })
                .catch(finalError => {
                    alert('Camera not available. Please check permissions.');
                });
            });
        });
    });
    
    // File upload handlers
    document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const fileInputId = this.getAttribute('data-target');
            document.getElementById(fileInputId).click();
        });
    });
    
    document.querySelectorAll('.photo-file').forEach(input => {
        input.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                const photoType = this.getAttribute('data-type');
                const cubeNum = this.getAttribute('data-cube');
                const file = this.files[0];
                
                // Compress image before upload if it's an image file
                if (file.type.startsWith('image/')) {
                    compressImage(file, 0.7, 1200).then(compressedFile => {
                        const formData = new FormData();
                        formData.append('photo_file', compressedFile);
                        formData.append('photo_type', photoType);
                        formData.append('cube_number', cubeNum);
                        
                        uploadPhoto(formData);
                    }).catch(error => {
                        console.error('Error compressing image:', error);
                        // Fall back to original file if compression fails
                        const formData = new FormData();
                        formData.append('photo_file', file);
                        formData.append('photo_type', photoType);
                        formData.append('cube_number', cubeNum);
                        
                        uploadPhoto(formData);
                    });
                } else {
                    const formData = new FormData();
                    formData.append('photo_file', file);
                    formData.append('photo_type', photoType);
                    formData.append('cube_number', cubeNum);
                    
                    uploadPhoto(formData);
                }
            }
        });
    });
    
    // Delete photo handlers
    document.querySelectorAll('.delete-photo').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this photo?')) {
                const photoId = this.getAttribute('data-photo-id');
                const photoType = this.getAttribute('data-type');
                const cubeNum = this.getAttribute('data-cube');
                
                deletePhoto(photoId, photoType, cubeNum);
            }
        });
    });
    
    // Camera functions
    async function openCamera() {
        try {
            // Request permissions explicitly first
            if (navigator.permissions && navigator.permissions.query) {
                const permissionStatus = await navigator.permissions.query({name: 'camera'});
                
                if (permissionStatus.state === 'denied') {
                    alert('Camera permission is blocked. Please allow camera access in your browser settings.');
                    return;
                }
            }
            
            // Get media stream with enhanced mobile camera handling
            const constraints = {
                video: {
                    facingMode: { ideal: currentFacingMode },
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 720, min: 480 }
                },
                audio: false
            };
            
            // Force back camera for concrete testing - try multiple approaches
            try {
                // First try: exact environment constraint
                constraints.video.facingMode = { exact: 'environment' };
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('Successfully got back camera with exact constraint');
            } catch (exactError) {
                console.log('Exact environment failed, trying deviceId approach:', exactError);
                
                try {
                    // Second try: enumerate devices and select back camera
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('Available cameras:', videoDevices.length);
                    
                    // Find back camera (usually has 'back' or 'environment' in label)
                    let backCameraId = null;
                    for (const device of videoDevices) {
                        const label = (device.label || '').toLowerCase();
                        if (label.includes('back') || label.includes('environment') || label.includes('rear')) {
                            backCameraId = device.deviceId;
                            console.log('Found back camera:', device.label);
                            break;
                        }
                    }
                    
                    if (backCameraId) {
                        constraints.video = {
                            deviceId: { exact: backCameraId },
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        };
                        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                        console.log('Successfully got back camera with deviceId');
                    } else {
                        throw new Error('No back camera found');
                    }
                } catch (deviceError) {
                    console.log('DeviceId approach failed, trying ideal:', deviceError);
                    // Final fallback: ideal constraint
                    constraints.video.facingMode = { ideal: 'environment' };
                    delete constraints.video.deviceId;
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('Using ideal constraint as fallback');
                }
            }
            
            // Set stream to video element
            video.srcObject = videoStream;
            
            // Wait for video to be ready
            video.onloadedmetadata = function() {
                video.play();
                cameraModal.style.display = 'flex';
                console.log('Camera ready');
            };
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Error accessing camera: ' + error.message + '. Please make sure your camera is enabled and permissions are granted.');
        }
    }
    
    function closeCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => {
                track.stop();
                console.log('Camera track stopped');
            });
            videoStream = null;
        }
        cameraModal.style.display = 'none';
    }
    
    captureBtn.addEventListener('click', function() {
        try {
            // Capture image from video
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to high quality JPEG
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            console.log('Image captured successfully');
            
            // Close camera
            closeCamera();
            
            // Prepare upload data
            const formData = new FormData();
            formData.append('image_data', imageData);
            formData.append('photo_type', currentPhotoType);
            formData.append('cube_number', currentCubeNum);
            
            // Upload immediately
            uploadPhoto(formData);
            
        } catch (error) {
            console.error('Capture error:', error);
            alert('Failed to capture image: ' + error.message);
        }
    });
    
    cancelCaptureBtn.addEventListener('click', closeCamera);
    
    // Simple camera flip functionality
    flipCameraBtn.addEventListener('click', function() {
        // Close current camera
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        // Switch camera type
        const newFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        
        navigator.mediaDevices.getUserMedia({
            video: { 
                facingMode: { exact: newFacingMode },
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        })
        .then(stream => {
            videoStream = stream;
            video.srcObject = stream;
            video.play();
            currentFacingMode = newFacingMode;
            
            // Update button text
            flipCameraBtn.innerHTML = newFacingMode === 'environment' ? 
                '<i class="fas fa-sync-alt"></i> Switch to Front' : 
                '<i class="fas fa-sync-alt"></i> Switch to Back';
                
            console.log('Switched to:', newFacingMode);
        })
        .catch(error => {
            console.error('Camera switch failed:', error);
            alert('Cannot switch camera: ' + error.message);
        });
    });
    
    // Upload photo function with better loading states
    function uploadPhoto(formData) {
        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = '<div class="text-center p-3"><div class="spinner-border" role="status"><span class="visually-hidden">Uploading...</span></div><p>Uploading photo...</p></div>';
        loadingDiv.className = 'position-fixed top-50 start-50 translate-middle bg-white border rounded p-3 shadow';
        loadingDiv.style.zIndex = '9999';
        document.body.appendChild(loadingDiv);
        
        console.log('Uploading photo...');
        
        fetch('/test/{{ test.id }}/upload-photo', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            document.body.removeChild(loadingDiv);
            if (data.success) {
                // Show success message briefly before reload
                const successDiv = document.createElement('div');
                successDiv.innerHTML = '<div class="alert alert-success">Photo uploaded successfully!</div>';
                successDiv.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
                successDiv.style.zIndex = '9999';
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            document.body.removeChild(loadingDiv);
            console.error('Error uploading photo:', error);
            alert('Error uploading photo: ' + error.message + '. Please try again.');
        });
    }
    
    // Client-side image compression function
    function compressImage(file, quality = 0.7, maxSize = 1200) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculate new dimensions
                let { width, height } = img;
                if (Math.max(width, height) > maxSize) {
                    const scale = maxSize / Math.max(width, height);
                    width = Math.round(width * scale);
                    height = Math.round(height * scale);
                }
                
                // Set canvas dimensions
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to blob
                canvas.toBlob(resolve, 'image/jpeg', quality);
            };
            
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }
    
    // Delete photo function
    function deletePhoto(photoId, photoType, cubeNum) {
        const formData = new FormData();
        formData.append('photo_id', photoId);
        
        fetch('/test/{{ test.id }}/photos/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the UI
                const container = document.getElementById(`${photoType}_${cubeNum}_container`);
                container.innerHTML = '<span>No photo</span>';
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting photo:', error);
            alert('Error deleting photo. Please try again.');
        });
    }
</script>
{% endblock %}