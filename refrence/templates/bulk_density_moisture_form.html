{% extends "base.html" %}

{% block title %}Bulk Density and Moisture Content Testing{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-0"><i class="fas fa-weight-hanging me-2"></i>Bulk Density and Moisture Content Testing</h1>
                            <p class="mb-0">Material density analysis and moisture content testing</p>
                        </div>
                        <div>
                            <a href="{{ url_for('other_services') }}" class="btn btn-warning me-2">
                                <i class="fas fa-arrow-left me-2"></i>Back to Other Services
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-12">
                    <form method="POST" action="{{ url_for('bulk_density_moisture_form') }}">
                        {{ form.hidden_tag() }}
                        
                <!-- General Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>General Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customer_id" class="form-label">Customer *</label>
                                            <select class="form-select" id="customer_id" name="customer_id" required>
                                                <option value="">-- Select Customer --</option>
                                                {% for customer in customers %}
                                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                                        {% endfor %}
                                            </select>
                                    </div>
                                        <div class="mb-3">
                                            <label for="{{ form.sample_description.id }}" class="form-label">{{ form.sample_description.label }} *</label>
                                            {{ form.sample_description(class="form-control", rows="3", placeholder="Describe the sample...") }}
                                {% if form.sample_description.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.sample_description.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                                        <div class="mb-3">
                                            <label for="{{ form.date_of_receipt.id }}" class="form-label">{{ form.date_of_receipt.label }} *</label>
                                {{ form.date_of_receipt(class="form-control", type="date") }}
                                {% if form.date_of_receipt.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.date_of_receipt.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                                        <div class="mb-3">
                                            <label for="customer_site_name" class="form-label">Customer/Site Name & Address</label>
                                            <textarea class="form-control" id="customer_site_name" name="customer_site_name" rows="3" placeholder="Enter customer/site name and address"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ form.reference_number.id }}" class="form-label">{{ form.reference_number.label }}</label>
                                            {{ form.reference_number(class="form-control", placeholder="Enter reference number") }}
                                            {% if form.reference_number.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.reference_number.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="date_of_manufacturer" class="form-label">Date of Manufacturer</label>
                                            <input type="date" class="form-control" id="date_of_manufacturer" name="date_of_manufacturer">
                                        </div>
                                        <div class="mb-3">
                                            <label for="type_of_specimen" class="form-label">Type of Specimen</label>
                                            <input type="text" class="form-control" id="type_of_specimen" name="type_of_specimen" placeholder="e.g., Concrete, Aggregate, etc.">
                                        </div>
                                        <div class="mb-3">
                                            <label for="machine_used" class="form-label">Machine used for Testing</label>
                                            <input type="text" class="form-control" id="machine_used" name="machine_used" placeholder="e.g., Compression Testing Machine">
                                        </div>
                                        <div class="mb-3">
                                            <label for="location_of_test" class="form-label">Location of Test</label>
                                            <input type="text" class="form-control" id="location_of_test" name="location_of_test" placeholder="e.g., Laboratory, Site, etc.">
                                        </div>
                                        <div class="mb-3">
                                            <label for="capacity_range" class="form-label">Capacity/Range</label>
                                            <input type="text" class="form-control" id="capacity_range" name="capacity_range" placeholder="e.g., 2000 kN, 0-100%">
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ form.test_method.id }}" class="form-label">{{ form.test_method.label }} *</label>
                                {{ form.test_method(class="form-control") }}
                                {% if form.test_method.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.test_method.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2 -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Test Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.sample_test_code.id }}" class="form-label">{{ form.sample_test_code.label }} *</label>
                                            {{ form.sample_test_code(class="form-control", placeholder="e.g., SCN-2024001") }}
                                {% if form.sample_test_code.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.sample_test_code.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                                        <div class="mb-3">
                                            <label for="{{ form.date_of_testing.id }}" class="form-label">{{ form.date_of_testing.label }} *</label>
                                {{ form.date_of_testing(class="form-control", type="date") }}
                                {% if form.date_of_testing.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.date_of_testing.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                                        <div class="mb-3">
                                            <label for="date_of_report" class="form-label">Date of Report</label>
                                            <input type="date" class="form-control" id="date_of_report" name="date_of_report">
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ form.url_number.id }}" class="form-label">{{ form.url_number.label }} *</label>
                                            {{ form.url_number(class="form-control", placeholder="Enter URL number") }}
                                            {% if form.url_number.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.url_number.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ form.job_code_number.id }}" class="form-label">{{ form.job_code_number.label }} *</label>
                                            {{ form.job_code_number(class="form-control", placeholder="Enter job code number") }}
                                            {% if form.job_code_number.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.job_code_number.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="manufacturer" class="form-label">Manufacturer</label>
                                            <input type="text" class="form-control" id="manufacturer" name="manufacturer" placeholder="Enter manufacturer name">
                                        </div>
                                        <div class="mb-3">
                                            <label for="condition_of_specimen" class="form-label">Condition of Specimen</label>
                                            <input type="text" class="form-control" id="condition_of_specimen" name="condition_of_specimen" placeholder="e.g., Dry, Wet, Saturated">
                                        </div>
                                        <div class="mb-3">
                                            <label for="calibration_due_date" class="form-label">Calibration Due Date</label>
                                            <input type="date" class="form-control" id="calibration_due_date" name="calibration_due_date">
                                        </div>
                                        <div class="mb-3">
                                <label for="{{ form.environmental_conditions.id }}" class="form-label">{{ form.environmental_conditions.label }}</label>
                                            {{ form.environmental_conditions(class="form-control", placeholder="e.g., Laboratory Conditions") }}
                                {% if form.environmental_conditions.errors %}
                                    <div class="text-danger small">
                                        {% for error in form.environmental_conditions.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>

                        <!-- Test Results Table -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Test Results</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table class="table table-bordered table-sm" style="font-size: 0.875rem;">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th style="width: 30px; min-width: 30px; max-width: 30px; text-align: center; padding: 4px 2px;">Sr. No.</th>
                                                        <th style="width: 140px; min-width: 140px; max-width: 140px;">Weight of Sample before oven drying (kg)</th>
                                                        <th style="width: 140px; min-width: 140px; max-width: 140px;">Weight of Sample after oven drying (kg)</th>
                                                        <th style="width: 90px; min-width: 90px; max-width: 90px; text-align: center; padding: 0; vertical-align: middle;">
                                                            <div style="border-bottom: 1px solid white; padding: 8px 0; text-align: center; vertical-align: middle;">Size of Sample</div>
                                                            <div style="display: flex; border-top: 1px solid white; height: 100%; position: relative;">
                                                                <div style="flex: 1; text-align: center; font-size: 0.8rem; padding: 4px 2px; display: flex; align-items: center; justify-content: center; position: relative; vertical-align: middle;">
                                                                    <span style="display: flex; align-items: center; justify-content: center; height: 100%;">L (mm)</span>
                                                                    <div style="position: absolute; right: 0; top: -1px; bottom: -1px; width: 1px; background-color: white;"></div>
                                                                </div>
                                                                <div style="flex: 1; text-align: center; font-size: 0.8rem; padding: 4px 2px; display: flex; align-items: center; justify-content: center; position: relative; vertical-align: middle;">
                                                                    <span style="display: flex; align-items: center; justify-content: center; height: 100%;">B (mm)</span>
                                                                    <div style="position: absolute; right: 0; top: -1px; bottom: -1px; width: 1px; background-color: white;"></div>
                                                                </div>
                                                                <div style="flex: 1; text-align: center; font-size: 0.8rem; padding: 4px 2px; display: flex; align-items: center; justify-content: center; vertical-align: middle;">
                                                                    <span style="display: flex; align-items: center; justify-content: center; height: 100%;">D (mm)</span>
                                                                </div>
                                                            </div>
                                                        </th>
                                                        <th style="width: 100px; min-width: 100px; max-width: 100px;">Volume of Sample (m³)</th>
                                                        <th style="width: 120px; min-width: 120px; max-width: 120px;">Bulk Density (kg/m³)</th>
                                                        <th style="width: 120px; min-width: 120px; max-width: 120px;">Moisture Content (%)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td style="text-align: center; vertical-align: middle; font-weight: bold;">1</td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_before_1" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_after_1" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td style="padding: 0; vertical-align: middle;">
                                                            <div style="display: flex; height: 100%;">
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="length_1" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="breadth_1" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0;">
                                                                    <input type="number" class="form-control form-control-sm" name="depth_1" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; text-align: center;">
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><input type="number" class="form-control form-control-sm" name="volume_1" step="0.000001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="bulk_density_1" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="moisture_content_1" step="0.01" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                    </tr>
                                                    <tr>
                                                        <td style="text-align: center; vertical-align: middle; font-weight: bold;">2</td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_before_2" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_after_2" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td style="padding: 0; vertical-align: middle;">
                                                            <div style="display: flex; height: 100%;">
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="length_2" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="breadth_2" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0;">
                                                                    <input type="number" class="form-control form-control-sm" name="depth_2" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; text-align: center;">
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><input type="number" class="form-control form-control-sm" name="volume_2" step="0.000001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="bulk_density_2" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="moisture_content_2" step="0.01" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                    </tr>
                                                    <tr>
                                                        <td style="text-align: center; vertical-align: middle; font-weight: bold;">3</td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_before_3" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="weight_after_3" step="0.001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;"></td>
                                                        <td style="padding: 0; vertical-align: middle;">
                                                            <div style="display: flex; height: 100%;">
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="length_3" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0; border-right: 1px solid #dee2e6;">
                                                                    <input type="number" class="form-control form-control-sm" name="breadth_3" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; border-right: none; text-align: center;">
                                                                </div>
                                                                <div style="flex: 1; padding: 0;">
                                                                    <input type="number" class="form-control form-control-sm" name="depth_3" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem; border-radius: 0; text-align: center;">
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><input type="number" class="form-control form-control-sm" name="volume_3" step="0.000001" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="bulk_density_3" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                        <td><input type="number" class="form-control form-control-sm" name="moisture_content_3" step="0.01" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly></td>
                                                    </tr>
                                                    <!-- Average Row -->
                                                    <tr class="table-secondary">
                                                        <td colspan="5" class="text-end fw-bold" style="font-size: 1.2rem;">Average</td>
                                                        <td class="text-center fw-bold">
                                                            <input type="number" class="form-control form-control-sm" id="avg_bulk_density" name="avg_bulk_density" step="0.1" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly>
                                                        </td>
                                                        <td class="text-center fw-bold">
                                                            <input type="number" class="form-control form-control-sm" id="avg_moisture_content" name="avg_moisture_content" step="0.01" placeholder="" style="font-size: 0.8rem; padding: 0.25rem;" readonly>
                                                        </td>
                                                    </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Verification -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Verification</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6>Tested By</h6>
                                                <div class="mb-3">
                                                    <label for="tested_by_name" class="form-label">Name *</label>
                                                    <input type="text" class="form-control" id="tested_by_name" name="tested_by_name" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="tested_by_date" class="form-label">Date *</label>
                                                    <input type="date" class="form-control" id="tested_by_date" name="tested_by_date" required>
                            </div>
                                    </div>
                                            <div class="col-md-4">
                                                <h6>Checked By</h6>
                                                <div class="mb-3">
                                                    <label for="checked_by_name" class="form-label">Name *</label>
                                                    <input type="text" class="form-control" id="checked_by_name" name="checked_by_name" required>
                            </div>
                                                <div class="mb-3">
                                                    <label for="checked_by_date" class="form-label">Date *</label>
                                                    <input type="date" class="form-control" id="checked_by_date" name="checked_by_date" required>
                                    </div>
                            </div>
                                            <div class="col-md-4">
                                                <h6>Verified By</h6>
                                                <div class="mb-3">
                                                    <label for="verified_by_name" class="form-label">Name</label>
                                                    <input type="text" class="form-control" id="verified_by_name" name="verified_by_name" value="Prakarsh A Sangave">
                                    </div>
                                                <div class="mb-3">
                                                    <label for="verified_by_date" class="form-label">Date *</label>
                                                    <input type="date" class="form-control" id="verified_by_date" name="verified_by_date" required>
                            </div>
                                    </div>
                            </div>
                                    </div>
                            </div>
                                    </div>
                            </div>

                        <!-- Remarks -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-comment me-2"></i>Remarks</h5>
                                    </div>
                                    <div class="card-body">
                                        <textarea class="form-control" id="remarks" name="remarks" rows="4" placeholder="Enter any additional remarks or observations..."></textarea>
                            </div>
                                    </div>
                            </div>
                        </div>

                        <!-- Reviewed By and Authorized By Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Reviewed By</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="reviewed_by" class="form-label">Select Reviewer:</label>
                                            <select class="form-select" id="reviewed_by" name="reviewed_by" required>
                                                <option value="">-- Select a reviewer --</option>
                                                <option value="Lalita S. Dussa - Quality Manager" data-name="Lalita S. Dussa" data-designation="Quality Manager" data-graduation="B.Tech.(Civil)" selected>Lalita S. Dussa - Quality Manager</option>
                                                <option value="Prakarsha A. Sangave - Quality Manager" data-name="Prakarsha A. Sangave" data-designation="Quality Manager" data-graduation="B.Tech.(Civil)">Prakarsha A. Sangave - Quality Manager</option>
                                                <option value="Harsha Prakarsha Sangave - Quality Manager" data-name="Harsha Prakarsha Sangave" data-designation="Quality Manager" data-graduation="B.Tech.(Civil)">Harsha Prakarsha Sangave - Quality Manager</option>
                                                <option value="Amol A Adam - Quality Manager" data-name="Amol A Adam" data-designation="Quality Manager" data-graduation="B.Tech.(Civil)">Amol A Adam - Quality Manager</option>
                                                <option value="Aaquib J. Shaikh - Quality Manager" data-name="Aaquib J. Shaikh" data-designation="Quality Manager" data-graduation="B.Tech.(Civil)">Aaquib J. Shaikh - Quality Manager</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-user-shield me-2"></i>Authorized By</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="authorized_by" class="form-label">Authorized By:</label>
                                            <input type="text" class="form-control" id="authorized_by" name="authorized_by" value="Prakarsh Sangave" readonly style="background-color: rgba(108, 117, 125, 0.1); border-color: #495057; opacity: 0.9;">
                                        </div>
                            </div>
                                    </div>
                            </div>
                        </div>



                        <!-- Submit Buttons -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="submit" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-save me-2"></i>Save Test Data
                                </button>
                                <a href="{{ url_for('other_services') }}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </a>
                            </div>
                        </div>
                    </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates to today
    const today = new Date().toISOString().split('T')[0];
    
    // Set default dates for date fields
    const dateFields = [
        'date_of_receipt',
        'date_of_testing',
        'tested_by_date',
        'checked_by_date',
        'verified_by_date'
    ];
    
    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value) {
            field.value = today;
        }
    });

    // Function to calculate volume from L, B, D values
    function calculateVolume(rowNumber) {
        const length = parseFloat(document.querySelector(`input[name="length_${rowNumber}"]`).value) || 0;
        const breadth = parseFloat(document.querySelector(`input[name="breadth_${rowNumber}"]`).value) || 0;
        const depth = parseFloat(document.querySelector(`input[name="depth_${rowNumber}"]`).value) || 0;
        
        // Calculate volume: (L × B × D) / 1,000,000,000 to convert from mm³ to m³
        const volume = (length * breadth * depth) / 1000000000;
        
        // Update volume field with calculated value
        const volumeField = document.querySelector(`input[name="volume_${rowNumber}"]`);
        volumeField.value = volume.toFixed(6);
        
        // Trigger bulk density calculation after volume update
        calculateBulkDensity(rowNumber);
    }

    // Function to calculate bulk density from weight after oven drying and volume
    function calculateBulkDensity(rowNumber) {
        const weightAfter = parseFloat(document.querySelector(`input[name="weight_after_${rowNumber}"]`).value) || 0;
        const volume = parseFloat(document.querySelector(`input[name="volume_${rowNumber}"]`).value) || 0;
        
        // Calculate bulk density: Weight after oven drying (kg) / Volume (m³)
        let bulkDensity = 0;
        if (volume > 0) {
            bulkDensity = weightAfter / volume;
        }
        
        // Update bulk density field with calculated value
        const bulkDensityField = document.querySelector(`input[name="bulk_density_${rowNumber}"]`);
        bulkDensityField.value = bulkDensity.toFixed(1);
        
        // Trigger average calculation after bulk density update
        calculateAverages();
        
        // Trigger moisture content calculation after bulk density update
        calculateMoistureContent(rowNumber);
    }

    // Function to calculate moisture content using BODMAS rule
    function calculateMoistureContent(rowNumber) {
        const weightBefore = parseFloat(document.querySelector(`input[name="weight_before_${rowNumber}"]`).value) || 0;
        const weightAfter = parseFloat(document.querySelector(`input[name="weight_after_${rowNumber}"]`).value) || 0;
        
        // Calculate moisture content: ((A - B) / B) × 100
        // Following BODMAS: Brackets first, then Division, then Multiplication
        let moistureContent = 0;
        if (weightAfter > 0) {
            const difference = weightBefore - weightAfter;  // (A - B)
            const ratio = difference / weightAfter;         // (A - B) / B
            moistureContent = ratio * 100;                  // ((A - B) / B) × 100
        }
        
        // Update moisture content field with calculated value
        const moistureContentField = document.querySelector(`input[name="moisture_content_${rowNumber}"]`);
        moistureContentField.value = moistureContent.toFixed(2);
        
        // Trigger average calculation after moisture content update
        calculateAverages();
    }

    // Function to calculate averages for bulk density and moisture content
    function calculateAverages() {
        let bulkDensitySum = 0;
        let moistureContentSum = 0;
        let validBulkDensityCount = 0;
        let validMoistureContentCount = 0;
        
        // Calculate sum of all valid values for both columns
        for (let row = 1; row <= 3; row++) {
            const bulkDensity = parseFloat(document.querySelector(`input[name="bulk_density_${row}"]`).value) || 0;
            const moistureContent = parseFloat(document.querySelector(`input[name="moisture_content_${row}"]`).value) || 0;
            
            if (bulkDensity > 0) {
                bulkDensitySum += bulkDensity;
                validBulkDensityCount++;
            }
            
            if (moistureContent > 0) {
                moistureContentSum += moistureContent;
                validMoistureContentCount++;
            }
        }
        
        // Calculate averages
        const avgBulkDensity = validBulkDensityCount > 0 ? bulkDensitySum / validBulkDensityCount : 0;
        const avgMoistureContent = validMoistureContentCount > 0 ? moistureContentSum / validMoistureContentCount : 0;
        
        // Update average display
                    if (avgBulkDensity > 0) {
                document.getElementById('avg_bulk_density').value = avgBulkDensity.toFixed(1);
            } else {
                document.getElementById('avg_bulk_density').value = '';
            }

            if (avgMoistureContent > 0) {
                document.getElementById('avg_moisture_content').value = avgMoistureContent.toFixed(2);
            } else {
                document.getElementById('avg_moisture_content').value = '';
            }
    }

    // Add event listeners for L, B, D input fields for all three rows
    for (let row = 1; row <= 3; row++) {
        const lengthField = document.querySelector(`input[name="length_${row}"]`);
        const breadthField = document.querySelector(`input[name="breadth_${row}"]`);
        const depthField = document.querySelector(`input[name="depth_${row}"]`);
        const weightBeforeField = document.querySelector(`input[name="weight_before_${row}"]`);
        const weightAfterField = document.querySelector(`input[name="weight_after_${row}"]`);
        
        // Add event listeners for L, B, D fields (triggers volume and bulk density calculations)
        [lengthField, breadthField, depthField].forEach(field => {
            field.addEventListener('input', () => calculateVolume(row));
            field.addEventListener('change', () => calculateVolume(row));
        });
        
        // Add event listeners for weight fields (triggers bulk density and moisture content calculations)
        weightBeforeField.addEventListener('input', () => calculateMoistureContent(row));
        weightBeforeField.addEventListener('change', () => calculateMoistureContent(row));
        
        weightAfterField.addEventListener('input', () => {
            calculateBulkDensity(row);
            calculateMoistureContent(row);
        });
        weightAfterField.addEventListener('change', () => {
            calculateBulkDensity(row);
            calculateMoistureContent(row);
        });
    }
});
</script>
{% endblock %}
