<!-- Calibration Date Update Modal -->
<div class="modal fade" id="calibrationModal" tabindex="-1" aria-labelledby="calibrationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="calibrationModalLabel">Update Calibration Date</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          Current calibration date is near expiry. Please update to the next calibration date.
        </div>
        <form id="calibrationForm">
          <div class="mb-3">
            <label for="currentCalibrationDate" class="form-label">Current Calibration Date</label>
            <input type="text" class="form-control" id="currentCalibrationDate" readonly>
          </div>
          <div class="mb-3">
            <label for="newCalibrationDate" class="form-label">New Calibration Date</label>
            <input type="date" class="form-control" id="newCalibrationDate" required>
          </div>
          <div class="text-muted small">
            <i class="fas fa-info-circle"></i>
            Calibration is typically updated annually. Please select the next year's date.
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" id="updateCalibrationBtn">
          <i class="fas fa-calendar-alt"></i> Update Calibration Date
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Immediately remove any existing calibration buttons (runs before DOM is ready)
(function() {
    // Remove any existing calibration buttons immediately
    const existingBtn = document.getElementById('calibrationUpdateBtn');
    if (existingBtn) {
        console.log('Immediately removing existing calibration button');
        existingBtn.remove();
    }
    
    // Remove any existing calibration alerts
    const existingAlerts = document.querySelectorAll('.alert-warning');
    existingAlerts.forEach(alert => {
        if (alert.innerHTML.includes('Calibration')) {
            console.log('Immediately removing existing calibration alert');
            alert.remove();
        }
    });
})();

// Calibration date management
document.addEventListener('DOMContentLoaded', function() {
    // Force remove any existing calibration buttons first
    const existingBtn = document.getElementById('calibrationUpdateBtn');
    if (existingBtn) {
        console.log('Removing existing calibration button');
        existingBtn.remove();
    }
    
    // Remove any existing calibration alerts
    const existingAlerts = document.querySelectorAll('.alert-warning');
    existingAlerts.forEach(alert => {
        if (alert.innerHTML.includes('Calibration')) {
            console.log('Removing existing calibration alert');
            alert.remove();
        }
    });

    // Check calibration status from database
    checkCalibrationStatus();

    // Handle calibration update (delegate to dynamically added button)
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'updateCalibrationBtn') {
            const newDate = document.getElementById('newCalibrationDate').value;
            if (!newDate) {
                alert('Please select a new calibration date');
                return;
            }

            // Confirm update
            if (confirm(`Are you sure you want to update the calibration date to ${newDate}?`)) {
                updateCalibrationDate(newDate);
            }
        }
    });
});

function checkCalibrationStatus() {
    console.log('Checking calibration status...');
    
    // Static data from your PostgreSQL database
    // CTK-200: Fully automatic Digital Compression Testing Machine
    // Last maintenance: 2025-07-01
    // Next due date: 2026-07-01
    const machineData = {
        machine_name: "Fully automatic Digital Compression Testing Machine",
        machine_id: "CTK-200",
        last_maintenance_date: "2025-07-01",
        next_due_date: "2026-07-01"
    };
    
    // Calculate days remaining
    const today = new Date();
    const nextDue = new Date(machineData.next_due_date);
    const daysRemaining = Math.ceil((nextDue - today) / (1000 * 60 * 60 * 24));
    const isNearExpiry = daysRemaining <= 30;
    
    console.log('Calibration data:', {
        machine_name: machineData.machine_name,
        machine_id: machineData.machine_id,
        next_due_date: machineData.next_due_date,
        days_remaining: daysRemaining,
        is_near_expiry: isNearExpiry
    });
    
    if (isNearExpiry) {
        console.log('Showing calibration warning - days remaining:', daysRemaining);
        document.getElementById('currentCalibrationDate').value = machineData.next_due_date;
        
        // Show calibration update button/notification
        showCalibrationUpdateOption(machineData.machine_name, daysRemaining);
    } else {
        console.log('No calibration warning needed - days remaining:', daysRemaining);
        // Force remove any existing calibration buttons
        const existingBtn = document.getElementById('calibrationUpdateBtn');
        if (existingBtn) {
            console.log('Removing existing calibration button because not near expiry');
            existingBtn.remove();
        }
    }
}

function showCalibrationUpdateOption(machineName, daysRemaining) {
    console.log('Creating calibration button with days remaining:', daysRemaining);
    // Add calibration update button to the page header if not already present
    if (!document.getElementById('calibrationUpdateBtn')) {
        const updateBtn = document.createElement('button');
        updateBtn.type = 'button';
        // Check if we're on the home page dashboard card
        const isDashboardCard = document.getElementById('dashboardButtonContainer');
        updateBtn.className = isDashboardCard ? 'btn btn-warning btn-sm' : 'btn btn-warning btn-sm ms-2';
        updateBtn.id = 'calibrationUpdateBtn';
        updateBtn.setAttribute('data-bs-toggle', 'modal');
        updateBtn.setAttribute('data-bs-target', '#calibrationModal');
        updateBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Update Calibration (${daysRemaining} days left)`;
        
        // Find the dashboard button container on home page first
        let headerContainer = document.getElementById('dashboardButtonContainer');
        if (!headerContainer) {
            // Fallback: try to find any suitable container
            headerContainer = document.getElementById('headerButtonContainer');
            if (!headerContainer) {
                headerContainer = document.querySelector('.d-flex.justify-content-center.gap-2');
                if (!headerContainer) {
                    headerContainer = document.querySelector('.btn-group');
                    if (!headerContainer) {
                        headerContainer = document.querySelector('.text-md-end');
                    }
                }
            }
        }
        
        if (headerContainer) {
            headerContainer.appendChild(updateBtn);
            console.log('Calibration button added to header with days:', daysRemaining);
        } else {
            console.log('No suitable header container found for calibration button');
            // Create a fixed notification banner instead
            const banner = document.createElement('div');
            banner.className = 'alert alert-warning alert-dismissible fade show position-fixed';
            banner.style.cssText = 'top: 10px; right: 10px; z-index: 1050; max-width: 300px;';
            banner.innerHTML = `
                <strong>Calibration Alert!</strong> 
                <button type="button" class="btn btn-sm btn-warning ms-2" data-bs-toggle="modal" data-bs-target="#calibrationModal">
                    Update (${daysRemaining} days left)
                </button>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(banner);
        }
    } else {
        console.log('Calibration button already exists');
    }
}



function updateCalibrationDate(newDate) {
    // Send the date in YYYY-MM-DD format
    fetch('/calibration/update_date', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'new_date': newDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Calibration date updated successfully!');
            const modal = bootstrap.Modal.getInstance(document.getElementById('calibrationModal'));
            modal.hide();
            const updateBtn = document.getElementById('calibrationUpdateBtn');
            if (updateBtn) updateBtn.remove(); // Remove the update button
            location.reload(); // Refresh to update any displayed dates
        } else {
            alert('Error: ' + (data.error || 'Failed to update calibration date'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update calibration date. Please try again.');
    });
}




</script>