{% extends 'base.html' %}

{% block title %}Camera - {{ test_request.job_number }} - Vitrag Associates{% endblock %}

{% block styles %}
{{ super() }}
<style>
    #camera-container {
        position: relative;
        width: 100%;
        max-width: 640px;
        margin: 0 auto;
        border: 2px solid #343a40;
        border-radius: 5px;
        overflow: hidden;
        background-color: #000;
    }
    
    #camera-video {
        width: 100%;
        height: auto;
        display: block;
    }
    
    #camera-canvas {
        display: none;
    }
    
    #capture-btn {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.6);
        border: 3px solid white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    #capture-btn:hover {
        background-color: rgba(255, 255, 255, 0.8);
    }
    
    #capture-btn::after {
        content: '';
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        border-radius: 50%;
        background-color: #dc3545;
    }
    
    #camera-result {
        max-width: 100%;
        display: none;
        border: 2px solid #343a40;
        border-radius: 5px;
    }
    
    .camera-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='images/logo.png') }}?v={{ range(1000, 9999) | random }}" alt="Vitrag Associates Logo" height="50" class="me-3">
            <div>
                <h3 class="mb-0">Camera - {{ test_request.job_number }}</h3>
                <p class="mb-0 small">Customer: {{ customer.name }}</p>
            </div>
        </div>
        <div>
            <a href="{{ url_for('test_photos', test_id=test_request.id) }}" class="btn btn-light btn-sm me-2">
                <i class="fas fa-images"></i> Photos
            </a>
            <a href="{{ url_for('view_sample', id=test_request.id) }}" class="btn btn-light btn-sm">
                <i class="fas fa-eye"></i> View Test
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-8">
                <h4 class="mb-3">Camera Capture</h4>
                
                <div id="camera-container" class="mb-3">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="camera-canvas"></canvas>
                    <button type="button" id="capture-btn" title="Capture Photo"></button>
                </div>
                
                <div class="camera-actions mb-4" id="camera-actions">
                    <button type="button" class="btn btn-secondary" id="switch-camera-btn">
                        <i class="fas fa-sync"></i> Switch Camera
                    </button>
                </div>
                
                <div class="text-center mb-3">
                    <img id="camera-result" src="" alt="Captured photo">
                </div>
                
                <div class="d-flex justify-content-center" id="result-actions" style="display: none !important;">
                    <button type="button" class="btn btn-danger me-2" id="retake-btn">
                        <i class="fas fa-redo"></i> Retake
                    </button>
                    <button type="button" class="btn btn-success" id="save-btn">
                        <i class="fas fa-save"></i> Save Photo
                    </button>
                </div>
            </div>
            
            <div class="col-md-4" id="photo-form-container" style="display: none;">
                <h4 class="mb-3">Photo Details</h4>
                <form id="photo-form" action="{{ url_for('save_camera_photo', test_id=test_request.id) }}" method="POST">
                    <input type="hidden" name="image_data" id="image_data">
                    
                    <div class="mb-3">
                        <label for="photo_type" class="form-label">Photo Type</label>
                        <select name="photo_type" id="photo_type" class="form-select">
                            <option value="sample_photo">Sample Photo</option>
                            <option value="before_test">Before Test</option>
                            <option value="during_test">During Test</option>
                            <option value="after_test">After Test</option>
                            <option value="equipment">Equipment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="concrete_test_id" class="form-label">Related Concrete Test (Optional)</label>
                        <select name="concrete_test_id" id="concrete_test_id" class="form-select">
                            <option value="">-- None --</option>
                            {% for test in concrete_tests %}
                            <option value="{{ test.id }}">{{ test.id_mark }} - {{ test.grade }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea name="description" id="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save"></i> Save Photo
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="alert alert-warning mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i> If you don't see the camera feed, please ensure your browser has camera permissions enabled.
        </div>
        
        <div class="alert alert-info mb-3">
            <p class="mb-1"><strong>Instructions:</strong></p>
            <ol class="mb-0">
                <li>Click the red button to capture a photo</li>
                <li>Review the captured image</li>
                <li>Fill in the photo details in the form</li>
                <li>Click "Save Photo" to store the image</li>
            </ol>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const videoElement = document.getElementById('camera-video');
        const canvasElement = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const resultImg = document.getElementById('camera-result');
        const retakeBtn = document.getElementById('retake-btn');
        const saveBtn = document.getElementById('save-btn');
        const resultActions = document.getElementById('result-actions');
        const photoFormContainer = document.getElementById('photo-form-container');
        const imageDataInput = document.getElementById('image_data');
        
        let stream = null;
        let facingMode = 'environment'; // Start with back camera (if available)
        let photoTaken = false;
        
        // Function to resize an image to a maximum width and height
        function resizeImage(img, maxWidth, maxHeight) {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            // Calculate the new dimensions while maintaining aspect ratio
            if (width > height) {
                if (width > maxWidth) {
                    height *= maxWidth / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width *= maxHeight / height;
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            return canvas;
        }
        
        // Start camera when page loads
        startCamera();
        
        // Function to start the camera
        function startCamera() {
            // Stop any existing stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Get camera stream
            navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            })
            .then(function(mediaStream) {
                stream = mediaStream;
                videoElement.srcObject = mediaStream;
                videoElement.play();
                
                // Show camera UI, hide result UI
                videoElement.style.display = 'block';
                resultImg.style.display = 'none';
                resultActions.style.display = 'none';
                photoFormContainer.style.display = 'none';
                document.getElementById('camera-actions').style.display = 'flex';
                captureBtn.style.display = 'block';
                photoTaken = false;
            })
            .catch(function(error) {
                console.error('Camera error:', error);
                alert('Error accessing camera: ' + error.message);
            });
        }
        
        // Function to switch between front and back cameras
        switchCameraBtn.addEventListener('click', function() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            startCamera();
        });
        
        // Capture photo when button is clicked
        captureBtn.addEventListener('click', function() {
            // Set canvas dimensions to match the video
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            
            // Draw the current video frame on the canvas
            const context = canvasElement.getContext('2d');
            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            
            // Create a temporary image to use for resizing
            const tempImg = new Image();
            tempImg.onload = function() {
                // Resize the image to max dimensions of 1024x1024
                const resizedCanvas = resizeImage(tempImg, 1024, 1024);
                
                // Convert the resized canvas to image data URL with compression (JPEG 0.7 quality)
                const imageDataUrl = resizedCanvas.toDataURL('image/jpeg', 0.7);
                
                // Show the captured image
                resultImg.src = imageDataUrl;
                resultImg.style.display = 'block';
                videoElement.style.display = 'none';
                
                // Hide capture button and show retake/save buttons
                captureBtn.style.display = 'none';
                resultActions.style.display = 'flex';
                document.getElementById('camera-actions').style.display = 'none';
                
                // Store image data in the form
                imageDataInput.value = imageDataUrl;
                
                // Show the photo details form
                photoFormContainer.style.display = 'block';
                
                photoTaken = true;
            };
            
            // Set the source of the temporary image to the original canvas data
            tempImg.src = canvasElement.toDataURL('image/jpeg', 1.0);
        });
        
        // Retake photo when button is clicked
        retakeBtn.addEventListener('click', function() {
            startCamera();
        });
        
        // Save photo directly with the form submit
        saveBtn.addEventListener('click', function() {
            if (photoTaken) {
                document.getElementById('photo-form').submit();
            }
        });
    });
</script>
{% endblock %}