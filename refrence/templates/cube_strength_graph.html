{% extends 'base.html' %}

{% block title %}Concrete Cube Strength Graph - {{ test.sample_code_number }} - Vitrag Associates LLP{% endblock %}

{% block content %}
<div class="container mt-3">
    {% include 'includes/navigation.html' %}

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <!-- Mobile-first responsive header -->
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
            <div class="d-flex align-items-center mb-2 mb-lg-0">
                <img src="{{ url_for('static', filename='images/logo.png') }}?v={{ range(1000, 9999) | random }}" alt="Vitrag Associates Logo" height="40" class="me-2 d-none d-sm-block">
                <div>
                    <h3 class="mb-0 fs-5 fs-lg-4">Concrete Cube Strength Graph</h3>
                    <div class="mt-2">
                        <span class="badge bg-primary fs-6 p-2">Reference Number: {{ test.sample_code_number }}</span>
                    </div>
                </div>
            </div>
            <!-- Responsive button group -->
            <div class="d-flex flex-wrap gap-1">
                <a href="{{ url_for('view_test_results', test_request_id=test_request.id, test_id=test.id) }}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i><span class="d-none d-md-inline"> Back</span>
                </a>
                <!-- Observation PDF Buttons -->
                <a href="{{ url_for('view_observation_pdf', test_request_id=test_request.id, test_id=test.id) }}" class="btn btn-warning btn-sm" target="_blank">
                    <i class="fas fa-file-pdf"></i><span class="d-none d-lg-inline"> View PDF</span>
                </a>
                <a href="{{ url_for('view_observation_pdf', test_request_id=test_request.id, test_id=test.id, download='true') }}" class="btn btn-success btn-sm">
                    <i class="fas fa-download"></i><span class="d-none d-lg-inline"> Download</span>
                </a>
                <a href="#" class="btn btn-info btn-sm" id="printGraphBtn">
                    <i class="fas fa-print"></i><span class="d-none d-lg-inline"> Print</span>
                </a>
                
                {% if strength_data and strength_data.get('has_data') %}
                <a href="{{ url_for('generate_strength_graph_pdf', test_request_id=test_request.id, test_id=test.id) }}" class="btn btn-danger btn-sm" target="_blank">
                    <i class="fas fa-file-pdf"></i><span class="d-none d-lg-inline"> PDF</span>
                </a>
                
                <button class="btn btn-info btn-sm" onclick="window.print()">
                    <i class="fas fa-print"></i><span class="d-none d-lg-inline"> Print</span>
                </button>
                
                <button class="btn btn-warning btn-sm" id="emailBtn" data-bs-toggle="modal" data-bs-target="#emailModal">
                    <i class="fas fa-envelope"></i><span class="d-none d-lg-inline"> Email</span>
                </button>
                
                <button class="btn btn-success btn-sm" id="whatsappBtn" data-bs-toggle="modal" data-bs-target="#whatsappModal">
                    <i class="fab fa-whatsapp"></i><span class="d-none d-lg-inline"> WhatsApp</span>
                </button>
                {% endif %}
            
            <!-- Email Modal -->
            <div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="emailModalLabel">Send Report via Email</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="emailAddress" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="emailAddress" placeholder="Enter recipient email address" value="{% if customer.email %}{{ customer.email }}{% endif %}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="sendEmailBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- WhatsApp Modal -->
            <div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="whatsappModalLabel">Send Report via WhatsApp</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="whatsappNumber" class="form-label">WhatsApp Number</label>
                                <div class="input-group">
                                    <span class="input-group-text">+91</span>
                                    <input type="tel" class="form-control" id="whatsappNumber" placeholder="Enter 10-digit mobile number" value="{% if customer.phone %}{{ customer.phone }}{% endif %}" maxlength="10" pattern="[0-9]{10}">
                                </div>
                                <div class="form-text">Enter 10-digit mobile number without country code</div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="sendWhatsappBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-12">
                <form id="strengthForm" method="post" action="{{ url_for('save_strength_values', test_request_id=test_request.id, test_id=test.id) }}">
                    <h4 class="mb-3 fs-5">Enter Actual Cube Strength Values</h4>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-secondary">
                                <tr>
                                    <th class="text-center">Curing days</th>
                                    <th class="text-center">Required strength</th>
                                    <th class="text-center">Actual Cube strength</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="fw-semibold">7 days strength</td>
                                    <td>
                                        <input type="number" step="0.01" class="form-control form-control-sm" name="required_7" id="required_7" 
                                            value="{{ strength_data.get('required_7', '') }}" placeholder="Required strength">
                                    </td>
                                    <td>
                                        <input type="text" inputmode="decimal" class="form-control form-control-sm strength-input" name="actual_7" id="actual_7"
                                            value="{{ strength_data.get('actual_7', '') }}" placeholder="Actual strength">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">14 days strength</td>
                                    <td>
                                        <input type="number" step="0.01" class="form-control form-control-sm" name="required_14" id="required_14"
                                            value="{{ strength_data.get('required_14', '') }}" placeholder="Required strength">
                                    </td>
                                    <td>
                                        <input type="text" inputmode="decimal" class="form-control form-control-sm strength-input" name="actual_14" id="actual_14"
                                            value="{{ strength_data.get('actual_14', '') }}" placeholder="Actual strength">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-semibold">28 days strength</td>
                                    <td>
                                        <input type="number" step="0.01" class="form-control form-control-sm" name="required_28" id="required_28"
                                            value="{{ strength_data.get('required_28', '') }}" placeholder="Required strength">
                                    </td>
                                    <td>
                                        <input type="text" inputmode="decimal" class="form-control form-control-sm strength-input" name="actual_28" id="actual_28"
                                            value="{{ strength_data.get('actual_28', '') }}" placeholder="Actual strength">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Move observations table inside the form -->
                    <div class="card mb-4 mt-4">
                        <div class="card-header bg-white">
                            <h4 class="mb-0 text-center fw-bold text-dark fs-5">Observations</h4>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-bordered mb-0 table-sm">
                                    <tbody>
                                        <tr>
                                            <td class="text-center" style="width: 5%;">1.</td>
                                            <td style="width: 70%;">
                                                <span class="d-block">Compressive Strength acquired after specified duration</span>
                                            </td>
                                            <td style="width: 25%;">
                                                <select class="form-select form-select-sm" id="obs_strength_duration" name="obs_strength_duration">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">2.</td>
                                            <td>
                                                <span class="d-block">Individual test results within ±15% of average strength</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" id="obs_test_results" name="obs_test_results">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">3.</td>
                                            <td>
                                                <span class="d-block">Weight of cube</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" id="obs_weight" name="obs_weight">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">4.</td>
                                            <td>
                                                <span class="d-block">Type of failure Pattern as per IS 516(Part-1/Sec-1): - 2021 Fig.1</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" id="obs_failure_pattern" name="obs_failure_pattern">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">5.</td>
                                            <td>
                                                <span class="d-block">Bonding between Aggregates and cement paste.</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" id="obs_bonding" name="obs_bonding">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="text-center">6.</td>
                                            <td>
                                                <span class="d-block">Compressive Strength as per acceptance criteria as Cl.16.1 of IS 456:2000</span>
                                            </td>
                                            <td>
                                                <select class="form-select form-select-sm" id="obs_strength_criteria" name="obs_strength_criteria">
                                                    <option value="" selected>---------</option>
                                                    <option value="Satisfactory">Satisfactory</option>
                                                    <option value="Unsatisfactory">Unsatisfactory</option>
                                                </select>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-chart-bar me-2"></i> Generate Graph
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Responsive Graph display area -->
        <div class="row mt-4" id="graphSection" style="display: none;">
            <div class="col-12">
                <h4 class="text-center mb-3 fs-5">Fig. 2 – Graphical Representation of Comparison of Compressive Strengths</h4>
                <div class="card">
                    <div class="card-body text-center">
                        <div id="graphContainer" class="d-flex justify-content-center">
                            <!-- Graph will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Responsive Complete Test Button -->
                <div class="text-center mt-4">
                    <div class="card border-success">
                        <div class="card-body bg-light">
                            <h5 class="card-title text-success mb-3 fs-6">
                                <i class="fas fa-clipboard-check"></i> Test Completion
                            </h5>
                            <p class="card-text text-muted mb-3 small">
                                Generate final report and complete the testing process
                            </p>
                            <div class="d-grid d-md-block">
                                <a href="{{ url_for('complete_test', test_id=test_request.id) }}" class="btn btn-success btn-lg px-4 py-2">
                                    <i class="fas fa-clipboard-check me-2"></i> Complete Test
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if strength_data and strength_data.get('has_data') %}
        <div class="row mt-4">
            <div class="col-md-12">
                <h4 class="text-center mb-3">Fig. 2 – Graphical Representation of Comparison of Compressive Strengths</h4>
                <div class="card">
                    <div class="card-body text-center">
                        <img src="data:image/png;base64,{{ graph_image }}" class="img-fluid" alt="Compressive Strength Graph">
                    </div>
                </div>
                
                <!-- Enhanced Complete Test Button -->
                <div class="text-center mt-4">
                    <div class="card border-success">
                        <div class="card-body bg-light">
                            <h5 class="card-title text-success mb-3">
                                <i class="fas fa-clipboard-check"></i> Test Completion
                            </h5>
                            <p class="card-text text-muted mb-3">
                                Generate final report and complete the testing process
                            </p>
                            <a href="{{ url_for('complete_test', test_id=test_request.id) }}" class="btn btn-success btn-lg px-5 py-3">
                                <i class="fas fa-clipboard-check me-2"></i> Complete Test
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const printGraphBtn = document.getElementById('printGraphBtn');
    if (printGraphBtn) {
        printGraphBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.print();
        });
    }
    
    // Add validation for strength inputs
    document.querySelectorAll('.strength-input').forEach(function(input) {
        input.addEventListener('input', function(e) {
            // If empty value, allow it
            if (this.value.trim() === '') {
                return;
            }
            
            // Remove any non-numeric characters except decimal point
            let value = this.value.replace(/[^\d.]/g, '');
            
            // Ensure only one decimal point
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Allow zero and positive values (only check if negative)
            if (parseFloat(value) < 0) {
                value = "";
            }
            
            // Update the input value
            this.value = value;
        });
    });
    
    // Handle form submission for graph generation
    const strengthForm = document.getElementById('strengthForm');
    if (strengthForm) {
        strengthForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        let isValid = true;
        let hasRequiredStrength = false;
        let hasActualStrength = false;
        
        // Check required strength fields (at least one must be filled)
        document.querySelectorAll('input[name^="required_"]').forEach(function(input) {
            const value = input.value.trim();
            if (value !== '' && value !== 'Required strength') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0) {
                    hasRequiredStrength = true;
                } else {
                    input.classList.add('is-invalid');
                    isValid = false;
                    
                    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                        const feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        feedback.textContent = 'Please enter a valid number (zero or positive).';
                        input.parentNode.appendChild(feedback);
                    }
                }
            } else {
                input.classList.remove('is-invalid');
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                    input.nextElementSibling.remove();
                }
            }
        });
        
        // Check actual strength fields
        document.querySelectorAll('.strength-input').forEach(function(input) {
            const value = input.value.trim();
            if (value !== '' && value !== 'Actual strength') {
                const numValue = parseFloat(value);
                if (!isNaN(numValue) && numValue >= 0) {
                    hasActualStrength = true;
                } else {
                    input.classList.add('is-invalid');
                    isValid = false;
                    
                    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('invalid-feedback')) {
                        const feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        feedback.textContent = 'Please enter a valid number (zero or positive).';
                        input.parentNode.appendChild(feedback);
                    }
                }
            } else {
                input.classList.remove('is-invalid');
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                    input.nextElementSibling.remove();
                }
            }
        });
        
        // Validation messages
        if (!hasRequiredStrength) {
            alert('Please enter at least one required strength value to generate the graph.');
            return;
        }
        
        if (!hasActualStrength) {
            alert('Please enter at least one actual strength value to generate the graph.');
            return;
        }
        
        if (!isValid) {
            alert('Please ensure all entered strength values are valid numbers (zero or positive).');
            return;
        }
        
        // If validation passed, generate the graph
        generateGraph();
        });
    }
    
    function generateGraph() {
        // Get the form data
        const strengthForm = document.getElementById('strengthForm');
        if (!strengthForm) return;
        
        const formData = new FormData(strengthForm);
        
        // Show loading indicator
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Graph...';
            submitBtn.disabled = true;
        }
        
        // Make AJAX request to generate graph
        fetch('{{ url_for("save_strength_values", test_request_id=test_request.id, test_id=test.id) }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display the graph
                const graphContainer = document.getElementById('graphContainer');
                graphContainer.innerHTML = '<img src="data:image/png;base64,' + data.graph_image + '" class="img-fluid" alt="Compressive Strength Graph">';
                
                // Show the graph section
                document.getElementById('graphSection').style.display = 'block';
                
                // Scroll to graph
                document.getElementById('graphSection').scrollIntoView({ behavior: 'smooth' });
                
                // Show success message
                showSnackbar('Graph generated successfully!', 'success');
            } else {
                showSnackbar('Error generating graph: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showSnackbar('Error generating graph. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    }
    
    function showSnackbar(message, type) {
        const snackbar = document.createElement('div');
        snackbar.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        snackbar.style.top = '20px';
        snackbar.style.right = '20px';
        snackbar.style.zIndex = '1055';
        snackbar.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(snackbar);
        
        setTimeout(() => {
            if (snackbar.parentNode) {
                snackbar.parentNode.removeChild(snackbar);
            }
        }, 5000);
    }
    
    // Email button click handler
    document.getElementById('sendEmailBtn').addEventListener('click', function() {
        const emailAddress = document.getElementById('emailAddress').value.trim();
        if (!emailAddress) {
            alert('Please enter an email address');
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(emailAddress)) {
            alert('Please enter a valid email address');
            return;
        }
        
        // Construct mailto URL
        const mailtoUrl = `mailto:${emailAddress}?subject=Strength Graph - {{ test.job_number }}&body=Please find the strength graph for {{ test.job_number }} attached.%0D%0A%0D%0ARegards,%0D%0AVitrag Associates LLP`;
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));
        modal.hide();
        
        // Open the email client
        window.open(mailtoUrl, '_blank');
    });
    
    // WhatsApp button click handler
    document.getElementById('sendWhatsappBtn').addEventListener('click', function() {
        const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
        if (!whatsappNumber) {
            alert('Please enter a WhatsApp number');
            return;
        }
        
        // Validate 10-digit number
        const numberRegex = /^\d{10}$/;
        if (!numberRegex.test(whatsappNumber)) {
            alert('Please enter a valid 10-digit mobile number');
            return;
        }
        
        // Construct WhatsApp URL
        const whatsappUrl = `https://wa.me/91${whatsappNumber}?text=Please find the strength graph for {{ test.job_number }} here: {{ url_for('generate_strength_graph_pdf', test_request_id=test_request.id, test_id=test.id, _external=True) }}`;
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('whatsappModal'));
        modal.hide();
        
        // Open WhatsApp
        window.open(whatsappUrl, '_blank');
    });
    
    // Handle observation dropdowns
    const observationSelects = [
        'obs_strength_duration',
        'obs_test_results',
        'obs_weight',
        'obs_failure_pattern',
        'obs_bonding',
        'obs_strength_criteria',
    ];
    
    // Load saved values from localStorage if they exist
    document.addEventListener('DOMContentLoaded', function() {
        // Load observation values
        observationSelects.forEach(function(selectId) {
            const element = document.getElementById(selectId);
            if (element) {
                const savedValue = localStorage.getItem(selectId);
                if (savedValue) {
                    element.value = savedValue;
                }
            }
        });
        
        // No conclusion value to load anymore
    });
    
    // Save values when changed
    observationSelects.forEach(function(selectId) {
        const selectElement = document.getElementById(selectId);
        if (selectElement) {
            selectElement.addEventListener('change', function() {
                localStorage.setItem(selectId, this.value);
            });
        }
    });
</script>
{% endblock %}