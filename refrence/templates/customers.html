{% extends 'base.html' %}

{% block title %}Customers - Vitrag Associates{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12 col-md-6 mb-2 mb-md-0">
            <h2 class="mb-0">Customer Management</h2>
        </div>
        <div class="col-12 col-md-6 text-md-end text-center" id="headerButtonContainer">
            <a href="{{ url_for('add_customer_form') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> <span class="d-none d-sm-inline">Add New User</span><span class="d-sm-none">Add New User</span>
            </a>
        </div>
    </div>

    <!-- Snackbar for notifications -->
    <div id="snackbar" class="snackbar">
        <span id="snackbar-message"></span>
        <button type="button" class="snackbar-close" onclick="closeSnackbar()">Ã—</button>
    </div>

    <div class="card mb-3 mb-md-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0 h6 h-md-5">Search Customers</h5>
        </div>
        <div class="card-body p-mobile-2">
            <form method="GET" action="{{ url_for('customers') }}">
                <div class="row g-2 g-md-3">
                    <div class="col-12 col-md-6 col-xl-4 mb-2 mb-md-0">
                        <label class="form-label d-block d-md-none small">Customer Name</label>
                        <input type="text" class="form-control" name="name" placeholder="Customer Name" value="{{ request.args.get('name', '') }}">
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 mb-2 mb-md-0">
                        <label class="form-label d-block d-md-none small">Phone Number</label>
                        <input type="text" class="form-control" name="phone" placeholder="Phone Number" value="{{ request.args.get('phone', '') }}">
                    </div>
                    <div class="col-12 col-md-6 col-xl-3 mb-2 mb-md-0">
                        <label class="form-label d-block d-md-none small">City</label>
                        <input type="text" class="form-control" name="city" placeholder="City" value="{{ request.args.get('city', '') }}">
                    </div>
                    <div class="col-12 col-md-6 col-xl-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i><span>Search</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Customers List</h5>
            <span class="badge bg-info">{{ customers|length }} customers found</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Sr. No.</th>
                            <th>Customer Name</th>
                            <th>Contact Person</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>City</th>
                            <th>Site Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if customers %}
                            {% for customer in customers %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ customer.name }}</td>
                                    <td>{{ customer.contact_person }}</td>
                                    <td>{{ customer.phone }}</td>
                                    <td>{{ customer.email }}</td>
                                    <td>{{ customer.city }}</td>
                                    <td>{{ customer.site_name }}</td>
                                    <td>
                                        <div class="d-flex flex-wrap gap-1" style="min-width: 200px;">
                                            <button type="button" class="btn btn-sm btn-warning edit-customer" 
                                                    data-id="{{ customer.id }}"
                                                    data-name="{{ customer.name }}"
                                                    data-contact-person="{{ customer.contact_person }}"
                                                    data-phone="{{ customer.phone }}"
                                                    data-email="{{ customer.email }}"
                                                    data-address="{{ customer.address }}"
                                                    data-city="{{ customer.city }}"
                                                    data-site-name="{{ customer.site_name }}"
                                                    title="Edit Customer">
                                                <i class="fas fa-edit"></i><span class="d-none d-xl-inline ms-1">Edit</span>
                                            </button>
                                            <a href="{{ url_for('view_customer_tests', customer_id=customer.id) }}" class="btn btn-sm btn-success" title="View Tests">
                                                <i class="fas fa-file-alt"></i><span class="d-none d-xl-inline ms-1">Tests</span>
                                            </a>
                                            <a href="{{ url_for('test_request_form', customer_id=customer.id) }}" class="btn btn-sm btn-info" title="New Test">
                                                <i class="fas fa-plus-circle"></i><span class="d-none d-xl-inline ms-1">New Test</span>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-danger delete-customer" 
                                                    data-id="{{ customer.id }}"
                                                    data-name="{{ customer.name }}"
                                                    title="Delete Customer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="py-4">
                                        <p class="mb-3">No customers found matching your search criteria.</p>
                                        <a href="{{ url_for('customers') }}" class="btn btn-primary">
                                            <i class="fas fa-list"></i> View All Details
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_customer') }}">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12 col-sm-6 col-md-4 mb-2 mb-md-0">
                            <label for="first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="first_name" name="first_name" required>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4 mb-2 mb-md-0">
                            <label for="last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="last_name" name="last_name" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="contact_person" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contact_person" name="contact_person">
                        </div>
                    </div>
                    <!-- Hidden field for backward compatibility -->
                    <input type="hidden" id="name" name="name">
                    <div class="row mb-3">
                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                            <label for="phone" class="form-label">Phone/Mobile</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="site_name" class="form-label">Site Name</label>
                            <input type="text" class="form-control" id="site_name" name="site_name">
                        </div>
                    </div>
                </div>
                <div class="modal-footer flex-column flex-sm-row">
                    <button type="button" class="btn btn-secondary w-100 w-sm-auto mb-2 mb-sm-0 me-sm-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary w-100 w-sm-auto">Save Customer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('update_customer') }}">
                <input type="hidden" id="edit_id" name="id">
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-12 col-sm-6 col-md-4 mb-2 mb-md-0">
                            <label for="edit_first_name" class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_first_name" name="first_name" required>
                        </div>
                        <div class="col-12 col-sm-6 col-md-4 mb-2 mb-md-0">
                            <label for="edit_last_name" class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_last_name" name="last_name" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label for="edit_contact_person" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="edit_contact_person" name="contact_person">
                        </div>
                    </div>
                    <!-- Hidden field for backward compatibility -->
                    <input type="hidden" id="edit_name" name="name">
                    <div class="row mb-3">
                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                            <label for="edit_phone" class="form-label">Phone/Mobile</label>
                            <input type="text" class="form-control" id="edit_phone" name="phone">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="edit_email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="edit_email" name="email">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="edit_address" class="form-label">Address</label>
                            <textarea class="form-control" id="edit_address" name="address" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                            <label for="edit_city" class="form-label">City</label>
                            <input type="text" class="form-control" id="edit_city" name="city">
                        </div>
                        <div class="col-12 col-md-6">
                            <label for="edit_site_name" class="form-label">Site Name</label>
                            <input type="text" class="form-control" id="edit_site_name" name="site_name">
                        </div>
                    </div>

                </div>
                <div class="modal-footer flex-column flex-sm-row">
                    <button type="button" class="btn btn-secondary w-100 w-sm-auto mb-2 mb-sm-0 me-sm-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary w-100 w-sm-auto">Update Customer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Customer Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCustomerModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center text-sm-start">
                <p class="mb-3">Are you sure you want to delete the customer: <strong id="delete_customer_name"></strong>?</p>
                <p class="text-danger mb-0"><i class="fas fa-exclamation-triangle"></i> This action cannot be undone. All test requests associated with this customer will also be deleted.</p>
            </div>
            <div class="modal-footer flex-column flex-sm-row">
                <button type="button" class="btn btn-secondary w-100 w-sm-auto mb-2 mb-sm-0 me-sm-2" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_customer') }}" class="w-100 w-sm-auto">
                    <input type="hidden" id="delete_id" name="id">
                    <button type="submit" class="btn btn-danger w-100">Delete Customer</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update the hidden name field when first or last name changes in the add modal
    function updateFullName() {
        const firstName = document.getElementById('first_name').value.trim();
        const lastName = document.getElementById('last_name').value.trim();
        document.getElementById('name').value = firstName + ' ' + lastName;
    }
    
    document.getElementById('first_name').addEventListener('input', updateFullName);
    document.getElementById('last_name').addEventListener('input', updateFullName);
    
    // Also update the hidden name field when first or last name changes in the edit modal
    function updateEditFullName() {
        const firstName = document.getElementById('edit_first_name').value.trim();
        const lastName = document.getElementById('edit_last_name').value.trim();
        document.getElementById('edit_name').value = firstName + ' ' + lastName;
    }
    
    document.getElementById('edit_first_name').addEventListener('input', updateEditFullName);
    document.getElementById('edit_last_name').addEventListener('input', updateEditFullName);
    
    // Update name on form submission
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            if (this.querySelector('#first_name')) {
                updateFullName();
            } else if (this.querySelector('#edit_first_name')) {
                updateEditFullName();
            }
        });
    });
    
    // Enhanced validation functions
    function validatePhone(input) {
        const phonePattern = /^[6-9]\d{9}$/;
        const value = input.value.replace(/\D/g, ''); // Remove non-digits
        
        // Update field with cleaned value
        input.value = value;
        
        // Validate
        if (value && !phonePattern.test(value)) {
            input.setCustomValidity('Phone number must be 10 digits starting with 6, 7, 8, or 9');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    }
    
    function validateEmail(input) {
        const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const value = input.value.trim().toLowerCase();
        
        // Update field with cleaned value
        input.value = value;
        
        if (value && !emailPattern.test(value)) {
            input.setCustomValidity('Please enter a valid email address');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    }
    
    function validateName(input) {
        const namePattern = /^[A-Za-z\s\.\-\']+$/;
        let value = input.value;
        
        if (value && !namePattern.test(value)) {
            input.setCustomValidity('Name must contain only letters, spaces, periods, hyphens, and apostrophes');
            input.classList.add('is-invalid');
        } else {
            // Auto-capitalize names
            value = value.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
            input.value = value;
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    }
    
    function validateTextSafety(input) {
        const dangerousPatterns = /<script|javascript:|onclick=|onerror=|drop\s+table|delete\s+from|insert\s+into/i;
        
        if (dangerousPatterns.test(input.value)) {
            input.setCustomValidity('Invalid characters detected in input');
            input.classList.add('is-invalid');
        } else {
            input.setCustomValidity('');
            input.classList.remove('is-invalid');
        }
    }
    
    // Apply validation to all relevant fields
    document.querySelectorAll('input[name="phone"], input[id*="phone"]').forEach(input => {
        input.addEventListener('input', () => validatePhone(input));
        input.addEventListener('blur', () => validatePhone(input));
    });
    
    document.querySelectorAll('input[type="email"], input[name="email"]').forEach(input => {
        input.addEventListener('input', () => validateEmail(input));
        input.addEventListener('blur', () => validateEmail(input));
    });
    
    document.querySelectorAll('input[name*="name"], input[id*="name"]').forEach(input => {
        if (input.type !== 'email' && !input.name.includes('site')) {
            input.addEventListener('input', () => validateName(input));
            input.addEventListener('blur', () => validateName(input));
        }
    });
    
    document.querySelectorAll('textarea, input[type="text"]').forEach(input => {
        input.addEventListener('input', () => validateTextSafety(input));
    });
    
    // Edit customer button handlers
    document.querySelectorAll('.edit-customer').forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const contactPerson = this.getAttribute('data-contact-person');
            const phone = this.getAttribute('data-phone');
            const email = this.getAttribute('data-email');
            const address = this.getAttribute('data-address');
            const city = this.getAttribute('data-city');
            const siteName = this.getAttribute('data-site-name');
            
            document.getElementById('edit_id').value = id;
            // Split the name into first and last name
            const nameParts = name ? name.split(' ') : ['', ''];
            const firstName = nameParts[0] || '';
            // Join the rest of the parts as the last name
            const lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';
            
            document.getElementById('edit_first_name').value = firstName;
            document.getElementById('edit_last_name').value = lastName;
            document.getElementById('edit_name').value = name; // Keep for backward compatibility
            document.getElementById('edit_contact_person').value = contactPerson || '';
            document.getElementById('edit_phone').value = phone || '';
            document.getElementById('edit_email').value = email || '';
            document.getElementById('edit_address').value = address || '';
            document.getElementById('edit_city').value = city || '';
            document.getElementById('edit_site_name').value = siteName || '';
            
            new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
        });
    });

    // Delete customer button handlers
    document.querySelectorAll('.delete-customer').forEach(function(button) {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            
            document.getElementById('delete_id').value = id;
            document.getElementById('delete_customer_name').textContent = name;
            
            new bootstrap.Modal(document.getElementById('deleteCustomerModal')).show();
        });
    });
});

// Snackbar functionality
function showSnackbar(message, type = 'success') {
    const snackbar = document.getElementById('snackbar');
    const messageSpan = document.getElementById('snackbar-message');
    
    messageSpan.textContent = message;
    snackbar.className = `snackbar ${type} show`;
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        closeSnackbar();
    }, 4000);
}

function closeSnackbar() {
    const snackbar = document.getElementById('snackbar');
    snackbar.classList.remove('show');
}

// Check for URL parameters to show success message
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'customer_added') {
        showSnackbar('Customer added successfully!', 'success');
        // Clean up the URL
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
});
</script>

<style>
.snackbar {
    visibility: hidden;
    min-width: 300px;
    margin-left: -150px;
    background-color: #28a745;
    color: white;
    text-align: center;
    border-radius: 8px;
    padding: 16px 20px;
    position: fixed;
    z-index: 1050;
    left: 50%;
    top: 20px;
    font-size: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: space-between;
    transform: translateY(-100px);
    transition: all 0.3s ease;
}

.snackbar.show {
    visibility: visible;
    transform: translateY(0);
}

.snackbar.success {
    background-color: #28a745;
}

.snackbar.error {
    background-color: #dc3545;
}

.snackbar.warning {
    background-color: #ffc107;
    color: #212529;
}

.snackbar-close {
    background: none;
    border: none;
    color: inherit;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 15px;
    padding: 0;
    line-height: 1;
}

.snackbar-close:hover {
    opacity: 0.7;
}
</style>
{% endblock %}