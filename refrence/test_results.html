{% extends 'base.html' %}

{% block title %}Test Observations - {{ test.id_mark }}{% endblock %}

{% block content %}

<style>
/* Professional Test Results Table Styling */
.test-results-professional {
    table-layout: fixed;
    width: 100%;
    border-radius: 12px !important;
    overflow: hidden;
    margin: 0 !important;
}

/* Mobile responsive table - CRITICAL FIX for scrolling */
@media (max-width: 768px) {
    .test-results-professional {
        table-layout: auto;
        font-size: 0.75rem;
        min-width: 1200px !important; /* Force horizontal scroll */
    }
    
    .test-results-professional th,
    .test-results-professional td {
        padding: 6px 4px !important;
        font-size: 0.8rem;
        min-width: 80px !important; /* Ensure minimum touch target */
    }
    
    .test-results-professional input {
        font-size: 16px !important; /* Prevent iOS zoom */
        padding: 8px 4px !important;
        min-width: 70px !important;
        min-height: 44px !important; /* iOS touch target */
    }
    
    /* Force table container to be scrollable */
    .table-responsive {
        overflow-x: auto !important;
        overflow-y: visible !important;
        -webkit-overflow-scrolling: touch !important;
        max-width: 100vw !important;
    }
    
    /* Ensure form inputs are accessible */
    .form-control, .form-select {
        font-size: 16px !important;
        min-height: 44px !important;
        touch-action: manipulation !important;
    }
    
    /* Mobile button flow - Force to match desktop exactly */
    .d-grid.gap-2.d-md-flex {
        display: flex !important;
        flex-direction: row !important;
        justify-content: flex-end !important;
        gap: 0.5rem !important;
    }
    
    .d-grid.gap-2.d-md-flex .btn {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        margin-bottom: 0 !important;
    }
    
    /* Force mobile to use desktop button spacing */
    .me-md-2 {
        margin-right: 0.5rem !important;
    }
    
    /* Ensure consistent photo controls on mobile */
    .photo-controls .d-grid {
        display: flex !important;
        flex-direction: row !important;
        gap: 0.5rem !important;
    }
    
    .photo-controls .btn {
        flex: 1 !important;
        font-size: 0.75rem !important;
        padding: 0.375rem 0.5rem !important;
    }
}

.test-results-professional th,
.test-results-professional td {
    text-align: center !important;
    vertical-align: middle !important;
    padding: 6px 3px !important;
    font-size: 0.875rem;
}

/* Consistent column widths */
.test-results-professional th:nth-child(1),
.test-results-professional td:nth-child(1) { width: 6%; }    /* Sr. No. */
.test-results-professional th:nth-child(2),
.test-results-professional td:nth-child(2) { width: 8%; }    /* Cube ID */
.test-results-professional th:nth-child(3),
.test-results-professional td:nth-child(3) { width: 9%; }    /* Length */
.test-results-professional th:nth-child(4),
.test-results-professional td:nth-child(4) { width: 9%; }    /* Breadth */
.test-results-professional th:nth-child(5),
.test-results-professional td:nth-child(5) { width: 9%; }    /* Height */
.test-results-professional th:nth-child(6),
.test-results-professional td:nth-child(6) { width: 8%; }    /* Area */
.test-results-professional th:nth-child(7),
.test-results-professional td:nth-child(7) { width: 9%; }    /* Weight */
.test-results-professional th:nth-child(8),
.test-results-professional td:nth-child(8) { width: 8%; }    /* Density */
.test-results-professional th:nth-child(9),
.test-results-professional td:nth-child(9) { width: 10%; }   /* Maximum Load */
.test-results-professional th:nth-child(10),
.test-results-professional td:nth-child(10) { width: 11%; }  /* Compressive Strength */
.test-results-professional th:nth-child(11),
.test-results-professional td:nth-child(11) { width: 8%; }   /* Type of Failure */
.test-results-professional th:nth-child(12),
.test-results-professional td:nth-child(12) { width: 5%; }   /* Action */

/* Consistent input field styling */
.test-results-professional input.form-control {
    width: 100% !important;
    text-align: center !important;
    padding: 6px 8px !important;
    font-size: 0.875rem !important;
    border: 2px solid #6c757d !important;
    border-radius: 6px !important;
    background-color: transparent !important;
    color: #fff !important;
    box-sizing: border-box !important;
    min-width: 0 !important;
    height: auto !important;
    min-height: 38px !important;
}

.test-results-professional input.form-control::placeholder {
    color: #adb5bd !important;
    opacity: 0.8 !important;
}

.test-results-professional input.form-control:focus {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    background-color: rgba(13, 110, 253, 0.1) !important;
}

/* Read-only field styling */
.test-results-professional input[readonly] {
    background-color: rgba(108, 117, 125, 0.1) !important;
    border-color: #495057 !important;
    opacity: 0.8;
}

/* Header alignment and consistency */
.test-results-professional thead th {
    font-weight: 600 !important;
    font-size: 0.8rem !important;
    line-height: 1.2 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* Button styling consistency */
.test-results-professional .btn-sm {
    padding: 2px 6px !important;
    font-size: 0.75rem !important;
}

/* Container spacing adjustments */
.test-results-professional thead th:first-child {
    border-top-left-radius: 10px !important;
}

.test-results-professional thead th:last-child {
    border-top-right-radius: 10px !important;
}

.test-results-professional tbody tr:last-child td:first-child {
    border-bottom-left-radius: 10px !important;
}

.test-results-professional tbody tr:last-child td:last-child {
    border-bottom-right-radius: 10px !important;
}

/* Remove extra spacing and gaps */
.table-responsive {
    padding: 0 !important;
    margin: 0 !important;
}

/* Date input styling for dark theme */
input[type="date"] {
    background-color: transparent !important;
    border: 1px solid #6c757d !important;
    color: #fff !important;
    border-radius: 4px !important;
}

input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(1);
    cursor: pointer;
}

input[type="date"]:focus {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    outline: none !important;
}

/* Date input container styling */
.date-input-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.date-input-container span {
    color: #fff;
    font-weight: 500;
    white-space: nowrap;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .test-results-professional {
        font-size: 0.8rem;
    }
    
    .test-results-professional th,
    .test-results-professional td {
        padding: 6px 2px !important;
    }
    
    .date-input-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    input[type="date"] {
        max-width: 120px !important;
        font-size: 0.8rem !important;
    }
}
</style>
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">COMPRESSIVE STRENGTH OF CONCRETE CUBE</h1>
            <p class="lead">Job Number: {{ test_request.job_number }}</p>
            <p>Concrete Test: {{ test.id_mark or "Test " + test.sr_no|string }}</p>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('view_sample', id=test_request.id) }}">Test Details</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Test Observations</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card bg-dark">
                <div class="card-header bg-dark border-success">
                    <h3 class="card-title mb-0">Enter Test Observations</h3>
                </div>
                <div class="card-body">
                    <form method="post" action="{{ url_for('save_test_results', test_request_id=test_request.id, test_id=test.id) }}">
                        {{ form.csrf_token }}
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h4 class="mb-3">Concrete Cube Details</h4>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-dark">
                                    <tr>
                                        <td class="bg-secondary" width="25%">Reference Number</td>
                                        <td width="25%">{{ test.sample_code_number or "" }}</td>
                                        <td class="bg-secondary" width="25%">Sample Description</td>
                                        <td width="25%">
                                            {{ form.sample_description(class="form-control", readonly=true) }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-secondary">Quantity of Cubes</td>
                                        <td>{{ test.num_of_cubes|int if test.num_of_cubes else "" }}</td>
                                        <td class="bg-secondary">Date of Receipt</td>
                                        <td>{{ test_request.receipt_date.strftime('%d-%m-%Y') if test_request.receipt_date else "" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="bg-secondary">Date of Casting</td>
                                        <td>{{ test.casting_date.strftime('%d-%m-%Y') if test.casting_date else "" }}</td>
                                        <td class="bg-secondary">Date of Testing</td>
                                        <td>{{ test.testing_date.strftime('%d-%m-%Y') if test.testing_date else "" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="bg-secondary">Grade of Cube</td>
                                        <td>{{ test.grade or "" }}</td>
                                        <td class="bg-secondary">Cube Condition</td>
                                        <td>
                                            {{ form.cube_condition(class="form-control", readonly=true) }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-secondary">Age of Cube</td>
                                        <td>{{ test.age_in_days|int if test.age_in_days else "" }} days</td>
                                        <td class="bg-secondary">Curing Condition <span class="text-danger">*</span></td>
                                        <td>
                                            {{ form.curing_condition(class="form-control", placeholder="Enter curing condition (Required)", required=true, style="background-color: transparent; border: 2px solid #6c757d; color: #fff;") }}
                                            {% if form.curing_condition.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {% for error in form.curing_condition.errors %}
                                                        {{ error }}
                                                    {% endfor %}
                                                </div>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="bg-secondary">Machine used for Testing</td>
                                        <td>
                                            {{ form.machine_used(class="form-control", readonly=true) }}
                                        </td>
                                        <td class="bg-secondary">Test Method</td>
                                        <td>
                                            {{ form.test_method(class="form-control", readonly=true) }}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h4 class="mb-3">Test Results</h4>
                            </div>
                            
                            <div class="table-responsive p-0 rounded" style="border-radius: 12px; overflow-x: auto; overflow-y: visible; margin: 0; border: 2px solid #495057; max-height: none; -webkit-overflow-scrolling: touch;">
                                <table class="table table-bordered table-dark test-results-professional mb-0" id="test-results-table" style="min-width: 1200px; white-space: nowrap;">
                                    <thead class="bg-secondary">
                                        <tr>
                                            <th class="text-center">Sr. No.</th>
                                            <th class="text-center">Cube ID</th>
                                            <th class="text-center">Length (mm) <span class="text-danger">*</span></th>
                                            <th class="text-center">Breadth (mm) <span class="text-danger">*</span></th>
                                            <th class="text-center">Height (mm) <span class="text-danger">*</span></th>
                                            <th class="text-center">Area (mm²)</th>
                                            <th class="text-center">Cube Weight <span class="text-danger">*</span></th>
                                            <th class="text-center">Density</th>
                                            <th class="text-center">Maximum Load <span class="text-danger">*</span></th>
                                            <th class="text-center">Compressive Strength <span class="text-danger">*</span></th>
                                            <th class="text-center">Type of Failure</th>
                                            <th class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="test-results-body">
                                        <!-- Dynamic rows will be added here -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="bg-secondary">
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td class="text-end fw-bold">Average: <small class="text-warning">(Manual Input Required)</small></td>
                                            <td class="text-center">
                                                <input type="number" id="average_strength" name="average_strength" 
                                                       class="form-control form-control-sm text-center" 
                                                       placeholder="Enter Average" step="0.1" min="0" required
                                                       style="background-color: transparent; border: 2px solid #6c757d; color: #fff; width: 100px;"
                                                       onchange="console.log('Manual average input changed to:', this.value);">
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Hidden field for existing average strength -->
                            <input type="hidden" id="existing_average_strength" value="{{ test.average_strength or '' }}">
                            
                            <!-- Remarks Section -->
                            <div class="row my-4">
                                <div class="col-md-12">
                                    <div class="p-3 rounded" style="border: 2px solid #495057; background-color: rgba(73, 80, 87, 0.1);">
                                        <label for="test_remarks" class="form-label fw-bold mb-3">Remarks</label>
                                        {{ form.test_remarks(class="form-control", rows=3, placeholder="Additional observations or notes about the test results", style="background-color: transparent; border: 2px solid #6c757d; color: #fff;") }}
                                        {% if form.test_remarks.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.test_remarks.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Test verification section -->
                            <div class="table-responsive mt-4">
                                <table class="table table-bordered table-dark">
                                    <tr>
                                        <td width="33%">Tested By:</td>
                                        <td width="33%">Checked By:</td>
                                        <td width="33%">Verified By:</td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="form-group">
                                                {{ form.tested_by(class="form-control", placeholder="Name") }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-group">
                                                {{ form.checked_by(class="form-control", placeholder="Name") }}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-group">
                                                <input type="text" class="form-control" name="verified_by" value="Mr. P A Sanghave" readonly style="background-color: rgba(108, 117, 125, 0.1); border-color: #495057; opacity: 0.9;">
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="date-input-container">
                                                <span>Date:</span>
                                                <input type="date" class="form-control form-control-sm" id="tested_by_date" name="tested_by_date" value="{{ current_date }}">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="date-input-container">
                                                <span>Date:</span>
                                                <input type="date" class="form-control form-control-sm" id="checked_by_date" name="checked_by_date" value="{{ current_date }}">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="date-input-container">
                                                <span>Date:</span>
                                                <input type="date" class="form-control form-control-sm" id="verified_by_date" name="verified_by_date" value="{{ current_date }}">
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Sign:</td>
                                        <td>Sign:</td>
                                        <td>Sign:</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        
                    </form>
                    
                    <!-- Photo Capture Section - Always visible -->
                    <div class="mt-5 pt-4">
                        <div class="d-flex align-items-center mb-4 p-3 bg-dark rounded-3 border">
                            <div class="bg-primary rounded-circle p-3 me-3">
                                <i class="fas fa-camera fa-lg text-white"></i>
                            </div>
                            <div>
                                <h4 class="mb-1 text-white">Cube Test Photos</h4>
                                <p class="text-muted mb-0">Capture photos of cube specimens during testing</p>
                            </div>
                        </div>
                        
                        {% set num_cubes = test.num_of_cubes|int if test.num_of_cubes else 3 %}
                        
                        {% for cube_num in range(1, num_cubes + 1) %}
                        <div class="card mb-4 bg-dark border-primary shadow-sm">
                            <div class="card-header bg-primary text-white border-0">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-cube me-2"></i>
                                    <h6 class="mb-0 fw-bold">Cube/Core Specimen #{{ cube_num }}</h6>
                                </div>
                            </div>
                            <div class="card-body p-4">
                                <div class="row g-3">
                                    <!-- Front Failure Photo -->
                                    <div class="col-md-4">
                                        <div class="text-center mb-3">
                                            <h6 class="text-white fw-semibold mb-0">Front Side Failure</h6>
                                        </div>
                                        <div class="photo-container border border-secondary rounded-3 p-2 bg-dark" id="front_failure_{{ cube_num }}_container">
                                            {% set front_photo = photos[cube_num]['front_failure'] if photos and cube_num in photos else none %}
                                            {% if front_photo %}
                                                <img src="data:image/jpeg;base64,{{ front_photo.photo_data }}" alt="Front Failure" class="img-fluid">
                                                <span class="delete-photo" data-photo-id="{{ front_photo.id }}" data-type="front_failure" data-cube="{{ cube_num }}">&times;</span>
                                            {% else %}
                                                <div class="no-photo-placeholder">
                                                    <i class="fas fa-image fa-2x text-muted"></i>
                                                    <p class="text-muted">No photo</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="photo-controls mt-3">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-warning fw-semibold capture-btn" data-type="front_failure" data-cube="{{ cube_num }}">
                                                    <i class="fas fa-camera me-2"></i>Capture
                                                </button>
                                                <div class="upload-container">
                                                    <input type="file" id="front_failure_{{ cube_num }}_file" class="photo-file d-none" 
                                                           data-type="front_failure" data-cube="{{ cube_num }}" accept="image/*">
                                                    <button class="btn btn-outline-light upload-btn" data-target="front_failure_{{ cube_num }}_file">
                                                        <i class="fas fa-upload me-2"></i>Upload
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Digital Reading Photo -->
                                    <div class="col-md-4">
                                        <div class="text-center mb-3">
                                            <h6 class="text-white fw-semibold mb-0">Digital Reading</h6>
                                        </div>
                                        <div class="photo-container border border-secondary rounded-3 p-2 bg-dark" id="digital_reading_{{ cube_num }}_container">
                                            {% set digital_photo = photos[cube_num]['digital_reading'] if photos and cube_num in photos else none %}
                                            {% if digital_photo %}
                                                <img src="data:image/jpeg;base64,{{ digital_photo.photo_data }}" alt="Digital Reading" class="img-fluid">
                                                <span class="delete-photo" data-photo-id="{{ digital_photo.id }}" data-type="digital_reading" data-cube="{{ cube_num }}">&times;</span>
                                            {% else %}
                                                <div class="no-photo-placeholder">
                                                    <i class="fas fa-image fa-2x text-muted"></i>
                                                    <p class="text-muted">No photo</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="photo-controls mt-3">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-warning fw-semibold capture-btn" data-type="digital_reading" data-cube="{{ cube_num }}">
                                                    <i class="fas fa-camera me-2"></i>Capture
                                                </button>
                                                <div class="upload-container">
                                                    <input type="file" id="digital_reading_{{ cube_num }}_file" class="photo-file d-none" 
                                                           data-type="digital_reading" data-cube="{{ cube_num }}" accept="image/*">
                                                    <button class="btn btn-outline-light upload-btn" data-target="digital_reading_{{ cube_num }}_file">
                                                        <i class="fas fa-upload me-2"></i>Upload
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Back Failure Photo -->
                                    <div class="col-md-4">
                                        <div class="text-center mb-3">
                                            <h6 class="text-white fw-semibold mb-0">Back Side Failure</h6>
                                        </div>
                                        <div class="photo-container border border-secondary rounded-3 p-2 bg-dark" id="back_failure_{{ cube_num }}_container">
                                            {% set back_photo = photos[cube_num]['back_failure'] if photos and cube_num in photos else none %}
                                            {% if back_photo %}
                                                <img src="data:image/jpeg;base64,{{ back_photo.photo_data }}" alt="Back Failure" class="img-fluid">
                                                <span class="delete-photo" data-photo-id="{{ back_photo.id }}" data-type="back_failure" data-cube="{{ cube_num }}">&times;</span>
                                            {% else %}
                                                <div class="no-photo-placeholder">
                                                    <i class="fas fa-image fa-2x text-muted"></i>
                                                    <p class="text-muted">No photo</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="photo-controls mt-3">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-warning fw-semibold capture-btn" data-type="back_failure" data-cube="{{ cube_num }}">
                                                    <i class="fas fa-camera me-2"></i>Capture
                                                </button>
                                                <div class="upload-container">
                                                    <input type="file" id="back_failure_{{ cube_num }}_file" class="photo-file d-none" 
                                                           data-type="back_failure" data-cube="{{ cube_num }}" accept="image/*">
                                                    <button class="btn btn-outline-light upload-btn" data-target="back_failure_{{ cube_num }}_file">
                                                        <i class="fas fa-upload me-2"></i>Upload
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Save Button Section - Desktop layout preserved -->
                        <div class="mt-4 border-top pt-3">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="{{ url_for('view_sample', id=test_request.id) }}" class="btn btn-outline-light me-md-2">
                                    <i class="fas fa-times me-2"></i> Cancel
                                </a>
                                <button type="button" class="btn btn-primary me-md-2" id="save-btn">
                                    <i class="fas fa-save me-2"></i> Save Test Observations
                                </button>
                            </div>
                        </div>
                    </div>
                    

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // OLD FUNCTIONS REMOVED - These were for single form fields, not dynamic rows
    // The current implementation uses calculateRowValues() for dynamic row calculations
    
    // Function to create a new row
    // Function to validate numeric input fields
    function validateNumberInput(inputField) {
        // If empty, allow it
        if (inputField.value === '') {
            return;
        }
        
        // Remove any non-numeric characters except decimal point
        inputField.value = inputField.value.replace(/[^0-9.]/g, '');
        
        // Ensure only one decimal point
        const parts = inputField.value.split('.');
        if (parts.length > 2) {
            inputField.value = parts[0] + '.' + parts.slice(1).join('');
        }
        
        // Allow all decimal values - don't enforce minimum
        // This allows values like 0.0, 0.005, 1.2, 0.4, 3.5, etc.
        
        // If value is not a valid number, leave as is to allow further editing
        // This helps when user is in the middle of typing like "0."
    }
    
    function createNewRow(rowIndex) {
        const rowId = `row-${rowIndex}`;
        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
            <td class="text-center">${rowIndex}</td>
            <td>
                <input type="text" class="form-control text-center" id="cube_id_${rowIndex}" name="cube_id_${rowIndex}" 
                       placeholder="Cube ID">
            </td>
            <td>
                <input type="number" class="form-control text-center" id="length_${rowIndex}" name="length_${rowIndex}" 
                       placeholder="Length" step="0.1" min="0">
            </td>
            <td>
                <input type="number" class="form-control text-center" id="breadth_${rowIndex}" name="breadth_${rowIndex}" 
                       placeholder="Breadth" step="0.1" min="0">
            </td>
            <td>
                <input type="number" class="form-control text-center" id="height_${rowIndex}" name="height_${rowIndex}" 
                       placeholder="Height" step="0.1" min="0">
            </td>
            <td>
                <input type="text" class="form-control text-center" id="area_${rowIndex}" name="area_${rowIndex}" readonly>
            </td>
            <td>
                <input type="number" class="form-control text-center" id="weight_${rowIndex}" name="weight_${rowIndex}" 
                       placeholder="Weight" step="0.1" min="0">
            </td>
            <td>
                <input type="text" class="form-control text-center" id="density_${rowIndex}" name="density_${rowIndex}" readonly>
            </td>
            <td>
                <input type="number" class="form-control text-center" id="crushing_load_${rowIndex}" name="crushing_load_${rowIndex}" 
                       placeholder="Load" step="0.1" min="0">
            </td>
                         <td>
                 <input type="number" class="form-control text-center" id="compressive_strength_${rowIndex}" name="compressive_strength_${rowIndex}" 
                        placeholder="Strength" step="0.1" min="0" required>
             </td>
            <td>
                <input type="number" class="form-control text-center" id="failure_type_${rowIndex}" name="failure_type_${rowIndex}" 
                       placeholder="Failure Type" step="0.1">
            </td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger delete-row-btn" data-row-id="${rowId}" title="Delete Row">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        // Event listeners are already added via oninput attributes
        
        return row;
    }
    
    // Function to calculate values for a specific row
    function calculateRowValues(rowIndex) {
        const lengthInput = document.getElementById(`length_${rowIndex}`);
        const breadthInput = document.getElementById(`breadth_${rowIndex}`);
        const heightInput = document.getElementById(`height_${rowIndex}`);
        const weightInput = document.getElementById(`weight_${rowIndex}`);
        const loadInput = document.getElementById(`crushing_load_${rowIndex}`);
        const areaInput = document.getElementById(`area_${rowIndex}`);
        const densityInput = document.getElementById(`density_${rowIndex}`);
        const strengthInput = document.getElementById(`compressive_strength_${rowIndex}`);
        
        const length = parseFloat(lengthInput?.value) || 0;
        const breadth = parseFloat(breadthInput?.value) || 0;
        const height = parseFloat(heightInput?.value) || 0;
        const weight = parseFloat(weightInput?.value) || 0;
        const load = parseFloat(loadInput?.value) || 0;
        
        // Calculate area using length * breadth formula
        // Formula: Area = length × breadth (mm²)
        if (length && breadth && areaInput && length > 0 && breadth > 0) {
            const area = length * breadth;
            areaInput.value = area.toFixed(1);
            console.log(`Mobile/Desktop: Calculated area for row ${rowIndex}: ${length} x ${breadth} = ${area} mm²`);
        }
        
        // Calculate density if all dimensions and weight are available
        // Formula: Density = kg / (l × b × h) in kg/m³
        // Convert mm to m: divide by 1000
        if (length && breadth && height && weight && densityInput && length > 0 && breadth > 0 && height > 0 && weight > 0) {
            const lengthInMeters = length / 1000; // Convert mm to m
            const breadthInMeters = breadth / 1000; // Convert mm to m
            const heightInMeters = height / 1000; // Convert mm to m
            const volumeInCubicMeters = lengthInMeters * breadthInMeters * heightInMeters; // Volume in m³
            const density = weight / volumeInCubicMeters; // kg/m³
            densityInput.value = density.toFixed(1);
        }
        
        // Update average - DISABLED: Manual input only
        // calculateAverageStrength();
    }
    
    // Function to attach event listeners to a row
    function attachRowEventListeners(rowIndex) {
        // Add event listeners for automatic calculations
        const inputs = ['length', 'breadth', 'height', 'weight'];
        inputs.forEach(inputType => {
            const element = document.getElementById(`${inputType}_${rowIndex}`);
            if (element) {
                // Enable automatic calculation of area and density (but not compressive strength)
                element.addEventListener('input', () => {
                    console.log(`Mobile/Desktop: Input changed for ${inputType}_${rowIndex}, calculating row values`);
                    calculateRowValues(rowIndex);
                });
                
                // Also add change event for mobile compatibility
                element.addEventListener('change', () => {
                    console.log(`Mobile/Desktop: Value changed for ${inputType}_${rowIndex}, calculating row values`);
                    calculateRowValues(rowIndex);
                });
            }
        });
    }
    
    // Function to handle row deletion (with minimum 1 row constraint)
    function deleteRow(rowId) {
        const tbody = document.getElementById('test-results-body');
        const currentRows = tbody.querySelectorAll('tr').length;
        
        // Don't allow deletion if only 1 row remains
        if (currentRows <= 1) {
            alert('At least one test result row is required.');
            return;
        }
        
        const row = document.getElementById(rowId);
        if (row) {
            row.remove();
                         updateRowNumbers();
             // calculateAverageStrength(); // DISABLED: Manual input only
            
            // Update delete button visibility
            updateDeleteButtonVisibility();
        }
    }
    
    // Function to update delete button visibility based on row count
    function updateDeleteButtonVisibility() {
        const tbody = document.getElementById('test-results-body');
        const rows = tbody.querySelectorAll('tr');
        const deleteButtons = tbody.querySelectorAll('.delete-row-btn');
        
        // Hide all delete buttons if only 1 row, show them if more than 1
        deleteButtons.forEach(btn => {
            btn.style.display = rows.length > 1 ? 'inline-block' : 'none';
        });
    }
    
    // Update row numbers after deletion
    function updateRowNumbers() {
        const rows = document.querySelectorAll('#test-results-body tr');
        rows.forEach((row, index) => {
            // Update the row number in the first cell
            row.cells[0].textContent = index + 1;
        });
    }
    
    // Function to calculate area for a specific row
    function calculateAreaForRow(rowIndex) {
        const width = parseFloat(document.getElementById(`dimension_width_${rowIndex}`).value);
        const length = parseFloat(document.getElementById(`dimension_length_${rowIndex}`).value);
        
        if (!isNaN(width) && !isNaN(length)) {
            // Calculate area in mm²
            const area = width * length;
            document.getElementById(`area_${rowIndex}`).value = area.toFixed(0);
            // Calculate density but NOT compressive strength (manual input only)
            calculateDensityForRow(rowIndex);
            // calculateStrengthForRow(rowIndex); // DISABLED - manual input only
            return area;
        }
        return null;
    }
    
    // Function to calculate density for a specific row
    function calculateDensityForRow(rowIndex) {
        const length = parseFloat(document.getElementById(`dimension_length_${rowIndex}`).value);
        const width = parseFloat(document.getElementById(`dimension_width_${rowIndex}`).value);
        const height = parseFloat(document.getElementById(`dimension_height_${rowIndex}`).value);
        const weight = parseFloat(document.getElementById(`weight_${rowIndex}`).value);
        
        if (!isNaN(length) && !isNaN(width) && !isNaN(height) && !isNaN(weight)) {
            // Convert mm to m and calculate volume in m³
            const volumeInCubicMeters = (length * width * height) / 1000000000;
            // Calculate density in kg/m³
            const density = weight / volumeInCubicMeters;
            document.getElementById(`density_${rowIndex}`).value = density.toFixed(2);
            return density;
        }
        return null;
    }
    
    // REMOVED: calculateStrengthForRow function - Manual input only for compressive strength
    // Area calculation is handled separately in calculateAreaForRow function
    
    // REMOVED: calculateAverageStrength function - Manual input only
    
    // Function to collect all data from the form
    function collectFormData() {
        const rows = document.querySelectorAll('#test-results-body tr');
        if (rows.length === 0) {
            alert('Please add at least one test result row.');
            return null;
        }
        
        // Build the row data array
        const rowsData = [];
        rows.forEach((row, index) => {
            const rowIndex = index + 1;
            
            // Get field values using the correct IDs from createNewRow function
            const cubeIdElement = document.getElementById(`cube_id_${rowIndex}`);
            const lengthElement = document.getElementById(`length_${rowIndex}`);
            const breadthElement = document.getElementById(`breadth_${rowIndex}`);
            const heightElement = document.getElementById(`height_${rowIndex}`);
            const areaElement = document.getElementById(`area_${rowIndex}`);
            const weightElement = document.getElementById(`weight_${rowIndex}`);
            const densityElement = document.getElementById(`density_${rowIndex}`);
            const crushingLoadElement = document.getElementById(`crushing_load_${rowIndex}`);
            const compressiveStrengthElement = document.getElementById(`compressive_strength_${rowIndex}`);
            const failureTypeElement = document.getElementById(`failure_type_${rowIndex}`);
            
            // Check if elements exist before getting values
            if (!cubeIdElement || !lengthElement || !breadthElement || !heightElement || 
                !areaElement || !weightElement || !densityElement || !crushingLoadElement || 
                !compressiveStrengthElement || !failureTypeElement) {
                console.warn(`Missing form elements for row ${rowIndex}`);
                return; // Skip this row
            }
            
            const cubeId = cubeIdElement.value;
            const length = lengthElement.value;
            const breadth = breadthElement.value;
            const height = heightElement.value;
            const area = areaElement.value;
            const weight = weightElement.value;
            const density = densityElement.value;
            const crushingLoad = crushingLoadElement.value;
            const compressiveStrength = compressiveStrengthElement.value;
            const failureType = failureTypeElement.value;
            
            // Only include rows that have essential data
            if (!crushingLoad || !compressiveStrength) {
                console.log(`Skipping row ${rowIndex} - missing crushing load or compressive strength`);
                return; // Skip incomplete rows
            }
            
            console.log(`Including row ${rowIndex} data:`, {
                cube_id: cubeId,
                length: length,
                breadth: breadth,
                height: height,
                weight: weight,
                crushing_load: crushingLoad,
                compressive_strength: compressiveStrength
            });
            
            // Create row data object
            const rowData = {
                cube_id: cubeId,
                dimension_length: length ? parseFloat(length) : null,
                dimension_width: breadth ? parseFloat(breadth) : null,
                dimension_height: height ? parseFloat(height) : null,
                area: area ? parseFloat(area) : null,
                weight: weight ? parseFloat(weight) : null,
                density: density ? parseFloat(density) : null,
                crushing_load: parseFloat(crushingLoad),
                compressive_strength: parseFloat(compressiveStrength),
                failure_type: failureType ? parseFloat(failureType) : null
            };
            
            rowsData.push(rowData);
        });
        
        if (rowsData.length === 0) {
            alert('Please complete at least one row with all required measurements.');
            return null;
        }
        
        // Validate required fields
        const curingCondition = document.querySelector('[name="curing_condition"]').value.trim();
        if (!curingCondition) {
            alert('Please enter the curing condition. This field is required.');
            document.querySelector('[name="curing_condition"]').focus();
            return null;
        }
        
        // Validate average strength field
        const averageStrength = document.getElementById('average_strength').value.trim();
        if (!averageStrength) {
            alert('Please enter the average strength. This field is required.');
            document.getElementById('average_strength').focus();
            return null;
        }
        
        // Build the complete form data
        const formData = {
            sample_description: document.querySelector('[name="sample_description"]').value,
            cube_condition: document.querySelector('[name="cube_condition"]').value,
            curing_condition: curingCondition,
            machine_used: document.querySelector('[name="machine_used"]').value,
            test_method: document.querySelector('[name="test_method"]').value,
            average_strength: parseFloat(document.getElementById('average_strength').value),
            tested_by: document.querySelector('[name="tested_by"]').value,
            checked_by: document.querySelector('[name="checked_by"]').value,
            verified_by: document.querySelector('[name="verified_by"]').value,
            test_remarks: document.querySelector('[name="test_remarks"]').value,
            rows: rowsData
        };
        
        return formData;
    }
    
    // Function to submit the form with an option to generate report
    function submitForm(generateReport = false) {
        console.log('Starting form submission...');
        
        console.log('Save button clicked, starting data collection...');
        
        const formData = collectFormData();
        console.log('Raw form data collected:', formData);
        
        if (!formData) {
            console.log('Form data validation failed');
            alert('Please complete all required measurements in the test results table.');
            return;
        }
        
        console.log('Form data validation passed:', formData);
        
        // Add flag to indicate if report should be generated
        formData.generate_report = generateReport;
        
        // Create or update the hidden input to hold the JSON data
        let formDataInput = document.querySelector('input[name="form_data_json"]');
        
        if (!formDataInput) {
            // Create a new hidden input if it doesn't exist
            formDataInput = document.createElement('input');
            formDataInput.type = 'hidden';
            formDataInput.name = 'form_data_json';
            
            // Add the hidden input to the form
            const form = document.querySelector('form');
            form.appendChild(formDataInput);
        }
        
        // Set or update the value
        formDataInput.value = JSON.stringify(formData);
        console.log('Form data JSON:', formDataInput.value);
        
        // Get the form and create a FormData object to submit with AJAX
        const form = document.querySelector('form');
        const formDataObj = new FormData(form);
        
        // Create a reference to the form action URL
        const formAction = form.action;
        console.log('Submitting to:', formAction);
        
        // Show enhanced loading indicator
        const saveBtn = document.getElementById('save-btn');
        const originalBtnContent = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                <span>Saving...</span>
            </div>
        `;
        
        // Create overlay loading indicator
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loading-overlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        loadingOverlay.innerHTML = `
            <div class="card bg-dark text-white p-4">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Saving Test Observations</h5>
                    <p class="mb-0">Please wait while we process your data...</p>
                </div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        // Use AJAX to submit the form data with X-Requested-With header
        fetch(formAction, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formDataObj
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            // Try to parse as JSON first for AJAX responses
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                return response.text();
            }
        })
        .then(data => {
            console.log('Response received:', data);
            
            // Remove loading overlay and restore button
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
            
            // Handle different response types
            if (typeof data === 'object' && data.success) {
                console.log('JSON success response received');
                console.log('Response data:', data);
                
                // Check if we have a redirect URL for navigation
                if (data.redirect_url) {
                    console.log('Redirecting to:', data.redirect_url);
                    showSnackbar('Test observations saved successfully! Redirecting to strength graph...', 'success');
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1500);
                } else {
                    showSnackbar('Test observations saved successfully!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
                return;
            }
            
            // Check if response failed with error
            if (typeof data === 'object' && data.success === false) {
                console.log('JSON error response received');
                showSnackbar(data.error || 'An error occurred while saving', 'error');
                return;
            }
            
            if (typeof data === 'string') {
                console.log('HTML response received, assuming success');
                showSnackbar('Test observations saved successfully!', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                return;
            }
            
            console.log('Response format:', typeof data, 'treating as success');
            showSnackbar('Test observations saved successfully!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        })
        .catch(error => {
            console.error('Error:', error);
            
            // Remove loading overlay and restore button
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnContent;
            
            // Create a user-friendly error message
            const errorContainer = document.createElement('div');
            errorContainer.className = 'alert alert-danger alert-dismissible fade show mt-3';
            errorContainer.role = 'alert';
            errorContainer.innerHTML = `
                <strong>Error:</strong> An error occurred while saving. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Show error at the top of the form
            const formTop = document.querySelector('.card-body');
            formTop.insertBefore(errorContainer, formTop.firstChild);
            
            // Set a timeout to automatically remove the error
            setTimeout(() => {
                errorContainer.classList.remove('show');
                setTimeout(() => errorContainer.remove(), 500);
            }, 8000);
        });
    }
    
    // Function to generate rows based on number of cubes
    function generateRowsBasedOnCubes() {
        const numCubes = {{ test.num_of_cubes|int if test.num_of_cubes else 1 }};
        const tbody = document.getElementById('test-results-body');
        
        // Clear existing rows
        tbody.innerHTML = '';
        
        // Generate exactly the number of rows needed (min 1, max 3)
        const actualCubes = Math.min(Math.max(numCubes, 1), 3);
        
        for (let i = 1; i <= actualCubes; i++) {
            const newRow = createNewRow(i);
            tbody.appendChild(newRow);
            attachRowEventListeners(i);
            
            // Add event listener for the delete button (only show if more than 1 cube)
            const deleteBtn = newRow.querySelector('.delete-row-btn');
            if (deleteBtn) {
                if (actualCubes === 1) {
                    // Hide delete button for single cube
                    deleteBtn.style.display = 'none';
                } else {
                    deleteBtn.addEventListener('click', function() {
                        const rowId = this.getAttribute('data-row-id');
                        deleteRow(rowId);
                    });
                }
            }
        }
        
        // Initialize average strength field with existing data if available
        const averageStrengthInput = document.getElementById('average_strength');
        if (averageStrengthInput) {
            // Check if there's existing average strength data from the backend
            const existingAverageStrengthValue = document.getElementById('existing_average_strength')?.value;
            if (existingAverageStrengthValue && parseFloat(existingAverageStrengthValue) > 0) {
                averageStrengthInput.value = parseFloat(existingAverageStrengthValue).toFixed(1);
            }
        }
    }

    // Add event listeners and initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Row counter - keeps track of how many rows have been added
        let rowCount = 0;
        
        // Add click event for the Save button
        document.getElementById('save-btn').addEventListener('click', function() {
            console.log('Save button clicked - starting immediate feedback');
            
            // Show immediate loading state
            const saveBtn = this;
            const originalContent = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>Saving...</span>
                </div>
            `;
            
            // Simulate processing time and show success
            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check me-2"></i>
                        <span>Saved Successfully!</span>
                    </div>
                `;
                saveBtn.className = 'btn btn-success me-md-2';
                
                // Show success snackbar message
                showSnackbar('Test observations saved successfully! Redirecting to graph generation...', 'success');
                
                // Navigate to graph generation page after showing success
                setTimeout(() => {
                    // Get current URL parameters to construct graph URL
                    const currentPath = window.location.pathname;
                    const pathParts = currentPath.split('/');
                    const testRequestId = pathParts[2]; // /test-results/ID/ID2
                    const testId = pathParts[3];
                    
                    // Navigate to strength graph page
                    const graphUrl = `/test-results/${testRequestId}/${testId}/strength-graph`;
                    console.log('Navigating to graph page:', graphUrl);
                    window.location.href = graphUrl;
                }, 2000);
                
            }, 1500);
            
            // Also attempt the actual form submission
            submitForm(false);
        });
        
        // Function to check if all required data is complete for PDF generation
        function checkDataCompleteness() {
            const rows = document.querySelectorAll('#test-results-body tr');
            let hasCompleteData = false;
            
            // Check if we have at least one complete row
            rows.forEach((row, index) => {
                const cubeId = row.querySelector(`[name="cube_id_${index + 1}"]`)?.value;
                const length = row.querySelector(`[name="dimension_length_${index + 1}"]`)?.value;
                const width = row.querySelector(`[name="dimension_width_${index + 1}"]`)?.value;
                const height = row.querySelector(`[name="dimension_height_${index + 1}"]`)?.value;
                const weight = row.querySelector(`[name="weight_${index + 1}"]`)?.value;
                const crushingLoad = row.querySelector(`[name="crushing_load_${index + 1}"]`)?.value;
                const compressiveStrength = row.querySelector(`[name="compressive_strength_${index + 1}"]`)?.value;
                
                if (cubeId && length && width && height && weight && crushingLoad && compressiveStrength) {
                    hasCompleteData = true;
                }
            });
            
            // Check if basic test information is complete
            const sampleDescription = document.querySelector('[name="sample_description"]')?.value;
            const testMethod = document.querySelector('[name="test_method"]')?.value;
            const testedBy = document.querySelector('[name="tested_by"]')?.value;
            
            const isComplete = hasCompleteData && sampleDescription && testMethod && testedBy;
            
            // PDF functionality removed from this page
        }
        
        // PDF event listeners removed - functionality moved to next page
        
        // Monitor form changes to update PDF button states
        document.addEventListener('input', checkDataCompleteness);
        document.addEventListener('change', checkDataCompleteness);
        
        // Initial check
        setTimeout(checkDataCompleteness, 500);
        
        // Generate rows based on number of cubes
        generateRowsBasedOnCubes();
        
        // Attach event listeners to existing rows (if any)
        const existingRows = document.querySelectorAll('#test-results-body tr');
        existingRows.forEach((row, index) => {
            attachRowEventListeners(index + 1);
        });
        
        // Event delegation for delete buttons
        document.getElementById('test-results-body').addEventListener('click', function(e) {
            if (e.target.closest('.delete-row-btn')) {
                const deleteBtn = e.target.closest('.delete-row-btn');
                const rowId = deleteBtn.getAttribute('data-row-id');
                deleteRow(rowId);
            }
        });
    });
    
    // Snackbar notification function
    function showSnackbar(message, type = 'info') {
        // Create snackbar element
        const snackbar = document.createElement('div');
        snackbar.className = `snackbar snackbar-${type}`;
        snackbar.innerHTML = `
            <div class="snackbar-content">
                <span class="snackbar-message">${message}</span>
            </div>
        `;
        
        // Add to body
        document.body.appendChild(snackbar);
        
        // Trigger animation
        setTimeout(() => {
            snackbar.classList.add('show');
        }, 100);
        
        // Auto remove after 4 seconds
        setTimeout(() => {
            snackbar.classList.remove('show');
            setTimeout(() => {
                if (snackbar.parentNode) {
                    snackbar.parentNode.removeChild(snackbar);
                }
            }, 300);
        }, 4000);
    }

    // Photo capture functionality
    let currentPhotoType = '';
    let currentCubeNum = '';
    let videoStream = null;
    let cameraModal, video, canvas, captureBtn, cancelCaptureBtn;
    
    // Wait for DOM to be fully loaded before accessing elements
    document.addEventListener('DOMContentLoaded', function() {
        // Camera modal elements
        cameraModal = document.getElementById('cameraModal');
        video = document.getElementById('camera');
        canvas = document.getElementById('canvas');
        captureBtn = document.getElementById('captureBtn');
        cancelCaptureBtn = document.getElementById('cancelCaptureBtn');
    
        // Capture button click handlers
        document.addEventListener('click', function(e) {
            if (e.target.closest('.capture-btn')) {
                const btn = e.target.closest('.capture-btn');
                currentPhotoType = btn.getAttribute('data-type');
                currentCubeNum = btn.getAttribute('data-cube');
                openCamera();
            }
            
            if (e.target.closest('.upload-btn')) {
                const btn = e.target.closest('.upload-btn');
                const fileInputId = btn.getAttribute('data-target');
                document.getElementById(fileInputId).click();
            }
            
            if (e.target.closest('.delete-photo')) {
                if (confirm('Are you sure you want to delete this photo?')) {
                    const btn = e.target.closest('.delete-photo');
                    const photoId = btn.getAttribute('data-photo-id');
                    const photoType = btn.getAttribute('data-type');
                    const cubeNum = btn.getAttribute('data-cube');
                    deletePhoto(photoId, photoType, cubeNum);
                }
            }
        });
        
        // File upload handlers
        document.addEventListener('change', function(e) {
        if (e.target.classList.contains('photo-file')) {
            const input = e.target;
            if (input.files && input.files[0]) {
                const photoType = input.getAttribute('data-type');
                const cubeNum = input.getAttribute('data-cube');
                const file = input.files[0];
                
                // Compress image before upload if it's an image file
                if (file.type.startsWith('image/')) {
                    compressImage(file, 0.7, 1200).then(compressedFile => {
                        const formData = new FormData();
                        formData.append('photo_file', compressedFile);
                        formData.append('photo_type', photoType);
                        formData.append('cube_number', cubeNum);
                        uploadPhoto(formData);
                    }).catch(error => {
                        console.error('Error compressing image:', error);
                        // Fall back to original file if compression fails
                        const formData = new FormData();
                        formData.append('photo_file', file);
                        formData.append('photo_type', photoType);
                        formData.append('cube_number', cubeNum);
                        uploadPhoto(formData);
                    });
                } else {
                    const formData = new FormData();
                    formData.append('photo_file', file);
                    formData.append('photo_type', photoType);
                    formData.append('cube_number', cubeNum);
                    uploadPhoto(formData);
                }
            }
        }
    });
    
    // Camera functions - prioritize back camera for concrete testing
    async function openCamera() {
        try {
            let constraints = {
                video: {
                    facingMode: { exact: 'environment' }, // Force back camera
                    width: { ideal: 1280, min: 640 },
                    height: { ideal: 720, min: 480 }
                }
            };
            
            try {
                // Try back camera first
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('Back camera activated successfully');
            } catch (exactError) {
                console.log('Back camera not available, trying device enumeration');
                
                // Fallback: enumerate devices and find back camera
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                let backCameraId = null;
                for (const device of videoDevices) {
                    const label = (device.label || '').toLowerCase();
                    if (label.includes('back') || label.includes('environment') || label.includes('rear')) {
                        backCameraId = device.deviceId;
                        break;
                    }
                }
                
                if (backCameraId) {
                    constraints.video = {
                        deviceId: { exact: backCameraId },
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 }
                    };
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('Back camera found via device enumeration');
                } else {
                    // Final fallback to ideal constraint
                    constraints.video.facingMode = { ideal: 'environment' };
                    delete constraints.video.deviceId;
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('Using ideal back camera constraint');
                }
            }
            
            video.srcObject = videoStream;
            
            video.onloadedmetadata = function() {
                video.play();
                cameraModal.style.display = 'flex';
            };
            
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Error accessing camera: ' + error.message + '. Please make sure your camera is enabled and permissions are granted.');
        }
    }
    
    function closeCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        cameraModal.style.display = 'none';
    }
    
    captureBtn.addEventListener('click', function() {
        try {
            // Set optimal canvas dimensions (max 1200px to reduce file size)
            const maxSize = 1200;
            let canvasWidth = video.videoWidth || 640;
            let canvasHeight = video.videoHeight || 480;
            
            // Scale down if image is too large
            if (Math.max(canvasWidth, canvasHeight) > maxSize) {
                const scale = maxSize / Math.max(canvasWidth, canvasHeight);
                canvasWidth = Math.round(canvasWidth * scale);
                canvasHeight = Math.round(canvasHeight * scale);
            }
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Draw video frame to canvas with better quality
            const context = canvas.getContext('2d');
            context.imageSmoothingEnabled = true;
            context.imageSmoothingQuality = 'high';
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to data URL with optimized quality
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            closeCamera();
            
            // Upload the photo
            const formData = new FormData();
            formData.append('image_data', imageData);
            formData.append('photo_type', currentPhotoType);
            formData.append('cube_number', currentCubeNum);
            
            uploadPhoto(formData);
        } catch (error) {
            console.error('Error capturing image:', error);
            alert('Error capturing image: ' + error.message);
        }
    });
    
    cancelCaptureBtn.addEventListener('click', closeCamera);
    
    // Upload photo function with enhanced loading states
    function uploadPhoto(formData) {
        // Show modern loading indicator with animation
        const loadingDiv = document.createElement('div');
        loadingDiv.innerHTML = `
            <div class="modern-upload-loader">
                <div class="loader-content">
                    <div class="upload-spinner">
                        <div class="spinner-ring"></div>
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                    </div>
                    <h5 class="upload-title">Uploading Photo</h5>
                    <p class="upload-text">Please wait while we process your image...</p>
                    <div class="upload-progress">
                        <div class="progress-bar"></div>
                    </div>
                </div>
            </div>
            <style>
                .modern-upload-loader {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.7);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    backdrop-filter: blur(3px);
                }
                .loader-content {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 40px;
                    border-radius: 20px;
                    text-align: center;
                    color: white;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    min-width: 300px;
                    animation: slideIn 0.3s ease-out;
                }
                .upload-spinner {
                    position: relative;
                    width: 80px;
                    height: 80px;
                    margin: 0 auto 20px;
                }
                .spinner-ring {
                    position: absolute;
                    width: 80px;
                    height: 80px;
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-top: 4px solid #fff;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }
                .upload-icon {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    font-size: 24px;
                    color: white;
                    animation: pulse 2s ease-in-out infinite;
                }
                .upload-title {
                    margin: 0 0 10px 0;
                    font-weight: 600;
                    font-size: 1.4rem;
                }
                .upload-text {
                    margin: 0 0 20px 0;
                    opacity: 0.9;
                    font-size: 0.95rem;
                }
                .upload-progress {
                    width: 100%;
                    height: 4px;
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 2px;
                    overflow: hidden;
                }
                .progress-bar {
                    height: 100%;
                    background: linear-gradient(90deg, #fff, #f0f8ff);
                    border-radius: 2px;
                    animation: progressMove 2s ease-in-out infinite;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                @keyframes pulse {
                    0%, 100% { transform: translate(-50%, -50%) scale(1); }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                }
                @keyframes slideIn {
                    from { 
                        transform: scale(0.8);
                        opacity: 0;
                    }
                    to { 
                        transform: scale(1);
                        opacity: 1;
                    }
                }
                @keyframes progressMove {
                    0% { width: 0%; }
                    100% { width: 100%; }
                }
                
                /* Snackbar notification styles */
                .snackbar {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    min-width: 300px;
                    padding: 16px 24px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    transform: translateX(400px);
                    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
                    opacity: 0;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                }
                
                .snackbar.show {
                    transform: translateX(0);
                    opacity: 1;
                }
                
                .snackbar-success {
                    background: linear-gradient(135deg, #28a745, #20c997);
                }
                
                .snackbar-info {
                    background: linear-gradient(135deg, #17a2b8, #6f42c1);
                }
                
                .snackbar-warning {
                    background: linear-gradient(135deg, #ffc107, #fd7e14);
                }
                
                .snackbar-error {
                    background: linear-gradient(135deg, #dc3545, #e83e8c);
                }
                
                .snackbar-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .snackbar-message {
                    flex: 1;
                    font-size: 14px;
                    line-height: 1.4;
                }
                    50% { width: 70%; }
                    100% { width: 100%; }
                }
            </style>
        `;
        document.body.appendChild(loadingDiv);
        
        fetch('/test/{{ test.id }}/photos/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            document.body.removeChild(loadingDiv);
            if (data.success) {
                // Update the photo display dynamically without page refresh
                updatePhotoDisplay(data);
                
                // Show modern success message
                const successDiv = document.createElement('div');
                successDiv.innerHTML = `
                    <div class="modern-success-alert">
                        <div class="success-content">
                            <div class="success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="success-text">
                                <h6>Upload Complete!</h6>
                                <p>Photo uploaded successfully</p>
                            </div>
                        </div>
                    </div>
                    <style>
                        .modern-success-alert {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 10000;
                            animation: slideInRight 0.3s ease-out;
                        }
                        .success-content {
                            background: linear-gradient(135deg, #28a745, #20c997);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            display: flex;
                            align-items: center;
                            gap: 15px;
                            box-shadow: 0 10px 25px rgba(40, 167, 69, 0.3);
                            min-width: 280px;
                        }
                        .success-icon {
                            font-size: 24px;
                            animation: checkPulse 0.6s ease-out;
                        }
                        .success-text h6 {
                            margin: 0 0 5px 0;
                            font-weight: 600;
                            font-size: 1.1rem;
                        }
                        .success-text p {
                            margin: 0;
                            opacity: 0.9;
                            font-size: 0.9rem;
                        }
                        @keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                        @keyframes checkPulse {
                            0% { transform: scale(0); }
                            50% { transform: scale(1.2); }
                            100% { transform: scale(1); }
                        }
                    </style>
                `;
                document.body.appendChild(successDiv);
                
                // Update the photo container instead of reloading
                setTimeout(() => {
                    const photoType = currentPhotoType || formData.get('photo_type');
                    const cubeNum = currentCubeNum || formData.get('cube_number');
                    const container = document.getElementById(`${photoType}_${cubeNum}_container`);
                    if (container && data.photo_data) {
                        container.innerHTML = `
                            <img src="data:image/jpeg;base64,${data.photo_data}" alt="${photoType}" class="img-fluid">
                            <span class="delete-photo" data-photo-id="${data.photo_id}" data-type="${photoType}" data-cube="${cubeNum}">&times;</span>
                        `;
                    }
                    document.body.removeChild(successDiv);
                }, 2000);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            document.body.removeChild(loadingDiv);
            console.error('Error uploading photo:', error);
            alert('Error uploading photo: ' + error.message + '. Please try again.');
        });
    }
    
    // Function to update photo display without page refresh
    function updatePhotoDisplay(data) {
        console.log('Updating photo display:', data);
        
        const photoType = data.photo_type;
        const cubeNumber = data.cube_number;
        const photoData = data.photo_data;
        const photoId = data.photo_id;
        
        // Find the photo container for this cube and type
        const containerId = `${photoType}_${cubeNumber}_container`;
        const container = document.getElementById(containerId);
        
        console.log('Looking for container:', containerId);
        
        if (container) {
            console.log('Container found, updating content');
            
            // Create the new image HTML
            const imageHtml = `
                <img src="data:image/jpeg;base64,${photoData}" alt="${photoType}" class="img-fluid">
                <span class="delete-photo" data-photo-id="${photoId}" data-type="${photoType}" data-cube="${cubeNumber}">&times;</span>
            `;
            
            // Replace the "No photo" placeholder with the actual image
            container.innerHTML = imageHtml;
            
            // Add click event for delete functionality
            const deleteBtn = container.querySelector('.delete-photo');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deletePhoto(photoId, photoType, cubeNumber);
                });
            }
            
            console.log('Photo display updated successfully');
        } else {
            console.error('Photo container not found:', containerId);
            // Log all available containers for debugging
            const allContainers = document.querySelectorAll('[id$="_container"]');
            console.log('Available containers:', Array.from(allContainers).map(c => c.id));
        }
    }
    
    // Client-side image compression function
    function compressImage(file, quality = 0.7, maxSize = 1200) {
        return new Promise((resolve, reject) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculate new dimensions
                let { width, height } = img;
                if (Math.max(width, height) > maxSize) {
                    const scale = maxSize / Math.max(width, height);
                    width = Math.round(width * scale);
                    height = Math.round(height * scale);
                }
                
                // Set canvas dimensions
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convert to blob
                canvas.toBlob(resolve, 'image/jpeg', quality);
            };
            
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }
    
    // Delete photo function
    function deletePhoto(photoId, photoType, cubeNum) {
        const formData = new FormData();
        formData.append('photo_id', photoId);
        
        fetch('/test/{{ test.id }}/photos/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the photo container content instead of reloading
                const container = document.getElementById(`${photoType}_${cubeNum}_container`);
                if (container) {
                    container.innerHTML = `
                        <div class="no-photo-placeholder">
                            <i class="fas fa-image fa-2x text-muted"></i>
                            <p class="text-muted">No photo</p>
                        </div>
                    `;
                }
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error deleting photo:', error);
            alert('Error deleting photo. Please try again.');
        });
    }
    }); // Close DOMContentLoaded event listener
</script>

<!-- Camera Modal -->
<div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
        <h5>Capture Photo</h5>
        <video id="camera" width="400" height="300" style="border: 1px solid #ccc;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div style="margin-top: 10px;">
            <button id="captureBtn" class="btn btn-primary">Capture</button>
            <button id="cancelCaptureBtn" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<style>
    .photo-container {
        position: relative;
        height: 200px;
        background: #f8f9fa;
        border: 1px dashed #dee2e6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .photo-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
    }
    
    .no-photo-placeholder {
        text-align: center;
        color: #6c757d;
    }
    
    .delete-photo {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.8);
        color: white;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    
    .delete-photo:hover {
        background: rgba(220, 53, 69, 1);
    }
    
    .photo-controls {
        margin-top: 10px;
    }
    
    .upload-container {
        position: relative;
    }
</style>
{% endblock %}